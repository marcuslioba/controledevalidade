<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestão de Chamados - Igreja</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f5f7fa;
    margin: 0;
    padding: 20px;
    color: #333;
  }
  h1, h2 { margin-bottom: 1rem; }
  .container {
    max-width: 900px;
    margin: 0 auto;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
  th, td { padding: 0.75rem; border-bottom: 1px solid #ddd; text-align: left; }
  th { background-color: #f0f0f0; }
  button {
    background-color: #3498db; color: white; border: none; padding: 0.5rem 1rem;
    border-radius: 4px; cursor: pointer; font-weight: 600; margin-right: 0.5rem;
  }
  button:hover { background-color: #2980b9; }
  button.danger { background-color: #e74c3c; }
  button.danger:hover { background-color: #c0392b; }
  button.warning { background-color: #f39c12; }
  button.warning:hover { background-color: #d35400; }
  .form-group { margin-bottom: 1rem; }
  label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
  input, select, textarea { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
  .notification { padding: 1rem; margin-bottom: 1rem; border-radius: 4px; display: none; }
  .notification.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
  .notification.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  .priority-high { color: #e74c3c; font-weight: bold; }
  .priority-medium { color: #f39c12; font-weight: bold; }
  .priority-low { color: #27ae60; font-weight: bold; }
  .status-pending { background-color: #fff3cd; color: #856404; padding: 0.25rem 0.5rem; border-radius: 4px; }
  .status-approved { background-color: #d1ecf1; color: #0c5460; padding: 0.25rem 0.5rem; border-radius: 4px; }
  .status-paid { background-color: #d4edda; color: #155724; padding: 0.25rem 0.5rem; border-radius: 4px; }
  .status-denied { background-color: #f8d7da; color: #721c24; padding: 0.25rem 0.5rem; border-radius: 4px; }
  .hidden { display: none !important; }
  #status-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
  #status-modal .modal-card { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 6px 24px rgba(0,0,0,0.2); }
  .actions { display:flex; gap:8px; margin-top:12px; }
  /* Navbar styles (kept concise) */
  .navbar {
    background: #2575fc;
    color: white;
    padding: 10px 20px;
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 1000;
  }
  .nav-container { max-width: 900px; margin: 0 auto; display:flex; align-items:center; gap:12px; }
  .logo { font-weight:700; }
  .menu-toggle { display:none; background:none; border:none; color:white; font-size:20px; cursor:pointer; }
  .nav-links { list-style:none; display:flex; gap:12px; margin-left: 12px; flex: 1; }
  .nav-links a { color:white; text-decoration:none; font-weight:600; }
  .user-section { display:flex; gap:8px; align-items:center; }
  .user-photo { width:36px; height:36px; border-radius:50%; object-fit:cover; }
  .logout-btn { background:transparent; color:white; border:1px solid white; padding:6px 10px; border-radius:6px; cursor:pointer; }
  @media (max-width:760px) { .menu-toggle { display:block; } .nav-links { position:fixed; top:50px; left:0; right:0; background:#2575fc; flex-direction:column; display:none; } .nav-links.show { display:flex; } }
  .container { margin-top:70px; }
</style>
</head>
<body>
<nav class="navbar">
  <div class="nav-container">
    <div class="logo">Financeiro Igreja</div>
    <button class="menu-toggle" aria-label="Abrir menu">☰</button>
    <ul class="nav-links" role="navigation" aria-label="Menu principal">
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="categorias.html">Categorias</a></li>
      <li><a href="chamados.html" class="active">Chamados</a></li>
      <li><a href="financas.html">Financeiro</a></li>
      <li id="admin-menu-item" style="display:none;"><a href="usuarios.html">Usuários</a></li>
    </ul>
    <div class="user-section">
      <img src="https://placehold.co/100" alt="Foto do Usuário" class="user-photo" id="user-photo-img">
      <button class="logout-btn" id="logout-btn">Sair</button>
    </div>
  </div>
</nav>

<div class="container">
  <h1>Gestão de Chamados</h1>

  <div id="notification" class="notification" role="status" aria-live="polite"></div>

  <!-- Formulário de novo chamado -->
  <section id="new-call-section">
    <h2>Novo Chamado</h2>
    <div class="form-group">
      <label for="call-name">Nome</label>
      <input type="text" id="call-name" placeholder="Nome do chamado" />
    </div>
    <div class="form-group">
      <label for="call-category">Categoria</label>
      <select id="call-category">
        <option value="">Selecione uma categoria</option>
        <option value="infra">Infraestrutura</option>
        <option value="culto">Culto</option>
        <option value="eventos">Eventos</option>
        <option value="administrativo">Administrativo</option>
        <option value="caridade">Caridade</option>
      </select>
    </div>
    <div class="form-group">
      <label for="call-value">Valor (R$)</label>
      <input type="text" id="call-value" placeholder="R$ 0,00" inputmode="numeric" />
    </div>
    <div class="form-group">
      <label for="call-notes">Observações</label>
      <textarea id="call-notes" rows="3" placeholder="Observações sobre o chamado"></textarea>
    </div>
    <div class="form-group">
      <label for="call-priority">Prioridade</label>
      <select id="call-priority">
        <option value="low">Baixa</option>
        <option value="medium">Média</option>
        <option value="high">Alta</option>
      </select>
    </div>
    <div class="actions">
      <button id="create-call-btn">Criar Chamado</button>
    </div>
  </section>

  <!-- Lista de chamados -->
  <section>
    <h2>Meus Chamados</h2>
    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Categoria</th>
          <th>Valor</th>
          <th>Prioridade</th>
          <th>Status</th>
          <th>Data</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="calls-table-body">
        <!-- Chamados serão listados aqui -->
      </tbody>
    </table>
    <div id="no-calls" style="display:none; padding:12px; background:#fffbe6; border-radius:6px; margin-top:12px;">Nenhum chamado encontrado.</div>
  </section>
</div>

<!-- Modal para alterar status -->
<div id="status-modal" class="hidden" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="status-modal-title">
    <h3 id="status-modal-title">Alterar Status</h3>
    <div class="form-group">
      <label for="new-status">Novo Status</label>
      <select id="new-status">
        <option value="pending">Pendente</option>
        <option value="approved">Aprovado</option>
        <option value="paid">Pago</option>
        <option value="denied">Negado</option>
      </select>
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
      <button id="save-status-btn">Salvar</button>
      <button id="cancel-status-btn" class="danger">Cancelar</button>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
  // Configuração Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDiLxDM7ottlE-59G5Gjtsyb_qYWNGF57g",
    authDomain: "lagoinha-f73cc.firebaseapp.com",
    projectId: "lagoinha-f73cc",
    storageBucket: "lagoinha-f73cc.firebasestorage.app",
    messagingSenderId: "657454722836",
    appId: "1:657454722836:web:2ba3acd3c4712ccb609c01"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Elements
  const notification = document.getElementById('notification');
  const callsTableBody = document.getElementById('calls-table-body');
  const createCallBtn = document.getElementById('create-call-btn');
  const statusModal = document.getElementById('status-modal');
  const saveStatusBtn = document.getElementById('save-status-btn');
  const cancelStatusBtn = document.getElementById('cancel-status-btn');
  const newCallSection = document.getElementById('new-call-section');
  const callValueInput = document.getElementById('call-value');
  const noCallsEl = document.getElementById('no-calls');

  let currentUser = null;
  let currentUserRole = null;
  let currentCallId = null;
  let unsubscribeCalls = null; // to keep track of realtime listener

  // Currency formatter
  const currencyFormatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

  function showNotification(message, type = 'success', options = {}) {
    notification.innerHTML = message;
    notification.className = `notification ${type}`;
    notification.style.display = 'block';
    if (!options.sticky) {
      setTimeout(() => { notification.style.display = 'none'; }, 7000);
    }
  }

  function hideNotification(){
    notification.style.display = 'none';
  }

  // Helpers
  function getCategoryName(categoryKey) {
    const categories = { 'infra': 'Infraestrutura', 'culto': 'Culto', 'eventos': 'Eventos', 'administrativo': 'Administrativo', 'caridade': 'Caridade' };
    return categories[categoryKey] || categoryKey || '—';
  }
  function getPriorityClass(priority) { return `priority-${priority}`; }
  function getPriorityText(priority) {
    const priorities = { 'low': 'Baixa', 'medium': 'Média', 'high': 'Alta' };
    return priorities[priority] || priority || '—';
  }
  function getStatusText(status) {
    const statuses = { 'pending': 'Pendente', 'approved': 'Aprovado', 'paid': 'Pago', 'denied': 'Negado' };
    return statuses[status] || status || '—';
  }

  // Parse currency input (e.g., "R$ 1.500,00") to number (1500.00)
  function parseCurrencyInput(valueStr) {
    if (!valueStr) return NaN;
    const onlyDigits = String(valueStr).replace(/\D/g, '');
    if (onlyDigits.length === 0) return NaN;
    return parseInt(onlyDigits, 10) / 100;
  }

  // Format currency while typing
  function formatCurrencyInput(e) {
    let value = e.target.value || '';
    value = value.replace(/\D/g, '');
    if (value.length === 0) { e.target.value = ''; return; }
    let number = parseInt(value, 10) / 100;
    e.target.value = currencyFormatter.format(number);
  }
  callValueInput.addEventListener('input', formatCurrencyInput);

  // Create new call
  async function createCall(name, category, valueStr, notes, priority) {
    if (!currentUser) { showNotification('Usuário não autenticado.', 'error'); return; }

    const valueNum = parseCurrencyInput(valueStr);
    if (isNaN(valueNum)) { showNotification('Valor inválido. Use números (ex: R$ 1.500,00).', 'error'); return; }
    const rounded = Math.round(valueNum * 100) / 100;

    try {
      await db.collection('calls').add({
        userId: currentUser.uid,
        userName: currentUser.email || '',
        name: name,
        category: category,
        value: rounded,
        notes: notes,
        priority: priority,
        status: 'pending',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      showNotification('Chamado criado com sucesso!', 'success');
      // clear form
      document.getElementById('call-name').value = '';
      document.getElementById('call-category').value = '';
      document.getElementById('call-value').value = '';
      document.getElementById('call-notes').value = '';
      document.getElementById('call-priority').value = 'low';
    } catch (error) {
      showNotification(`Erro: ${error.message}`, 'error');
    }
  }

  // Render helper from documents array
  function renderCallsFromDocs(docsArray) {
    callsTableBody.innerHTML = '';
    if (!docsArray || docsArray.length === 0) {
      noCallsEl.style.display = 'block';
      return;
    } else {
      noCallsEl.style.display = 'none';
    }

    docsArray.forEach(doc => {
      const call = doc.data ? doc.data() : doc; // if it's a doc snapshot or plain object
      const id = (doc.id) ? doc.id : (doc._id || '');
      const valueToShow = (typeof call.value === 'number') ? call.value : (parseCurrencyInput(String(call.value || '0')) || 0);

      // Format createdAt
      let createdAtFormatted = '—';
      const createdAt = call.createdAt;
      if (createdAt && typeof createdAt.toDate === 'function') {
        createdAtFormatted = createdAt.toDate().toLocaleDateString('pt-BR');
      } else if (createdAt && (typeof createdAt === 'number' || createdAt instanceof Date)) {
        const d = (createdAt instanceof Date) ? createdAt : new Date(createdAt);
        createdAtFormatted = d.toLocaleDateString('pt-BR');
      }

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${call.name || ''}</td>
        <td>${getCategoryName(call.category)}</td>
        <td>${currencyFormatter.format(valueToShow)}</td>
        <td class="${getPriorityClass(call.priority)}">${getPriorityText(call.priority)}</td>
        <td><span class="status-${call.status}">${getStatusText(call.status)}</span></td>
        <td>${createdAtFormatted}</td>
        <td>
          ${ currentUserRole === 'admin' ? `<button data-id="${id}" class="change-status">Alterar Status</button>` : '' }
        </td>
      `;
      // store id for later
      tr.querySelector('td').setAttribute('data-doc-id', id);
      callsTableBody.appendChild(tr);
    });

    // Attach admin buttons if any
    if (currentUserRole === 'admin') {
      document.querySelectorAll('.change-status').forEach(btn => {
        btn.removeEventListener('click', onChangeStatusClick);
        btn.addEventListener('click', onChangeStatusClick);
      });
    }
  }

  // Load calls: tries real-time query with where+orderBy; fallback to .get() filtered client-side if index required
  function loadCalls() {
    // remove previous listener if exists
    if (unsubscribeCalls) {
      unsubscribeCalls();
      unsubscribeCalls = null;
    }

    callsTableBody.innerHTML = '';
    noCallsEl.style.display = 'none';
    hideNotification();

    let query = db.collection('calls');

    if (currentUserRole !== 'admin') {
      query = query.where('userId', '==', currentUser.uid);
    }

    // We attempt to listen with orderBy; this may require a composite index if where + orderBy used.
    try {
      unsubscribeCalls = query.orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        // convert snapshot to array and render
        const docs = snapshot.docs;
        if (!docs.length) {
          renderCallsFromDocs([]);
          return;
        }
        renderCallsFromDocs(docs);
      }, err => {
        // If the error indicates a missing index, show link and fallback
        console.error('onSnapshot error:', err);
        if (err && /requires an index/i.test(err.message || '')) {
          // extract link from message if present
          const urlMatch = (err.message || '').match(/https?:\/\/console\.firebase\.google\.com[^\s)]+/);
          const createIndexUrl = urlMatch ? urlMatch[0] : null;
          const linkHtml = createIndexUrl ? `<br/><a href="${createIndexUrl}" target="_blank" rel="noopener">Criar índice necessário no Console do Firebase</a>` : '';
          showNotification(`A consulta requer um índice no Firestore. ${linkHtml}`, 'error', { sticky: true });

          // Fallback: fetch user's calls without orderBy (or with single where) and sort client-side
          if (currentUserRole !== 'admin') {
            db.collection('calls').where('userId', '==', currentUser.uid).get().then(snapshot => {
              const docs = snapshot.docs.slice();
              // sort by createdAt descending in client (docs without createdAt go to end)
              docs.sort((a, b) => {
                const aTS = (a.data().createdAt && typeof a.data().createdAt.toDate === 'function') ? a.data().createdAt.toDate().getTime() : 0;
                const bTS = (b.data().createdAt && typeof b.data().createdAt.toDate === 'function') ? b.data().createdAt.toDate().getTime() : 0;
                return bTS - aTS;
              });
              renderCallsFromDocs(docs);
            }).catch(err2 => {
              console.error('Fallback get() error:', err2);
              showNotification(`Erro ao carregar chamados (fallback): ${err2.message}`, 'error');
            });
          } else {
            // admin fallback: try simple get() ordered client-side
            db.collection('calls').get().then(snapshot => {
              const docs = snapshot.docs.slice();
              docs.sort((a,b) => {
                const aTS = (a.data().createdAt && typeof a.data().createdAt.toDate === 'function') ? a.data().createdAt.toDate().getTime() : 0;
                const bTS = (b.data().createdAt && typeof b.data().createdAt.toDate === 'function') ? b.data().createdAt.toDate().getTime() : 0;
                return bTS - aTS;
              });
              renderCallsFromDocs(docs);
              showNotification('Consulta carregada via fallback. Crie o índice para usar realtime queries com ordenação.', 'warning');
            }).catch(err2 => {
              console.error('Fallback admin get() error:', err2);
              showNotification(`Erro ao carregar chamados: ${err2.message}`, 'error');
            });
          }
        } else {
          showNotification(`Erro ao carregar chamados: ${err.message || err}`, 'error');
        }
      });
    } catch (ex) {
      console.error('loadCalls exception:', ex);
      showNotification('Erro ao iniciar escuta de chamados: ' + (ex.message || ex), 'error');
    }
  }

  function onChangeStatusClick(e) {
    if (currentUserRole !== 'admin') {
      showNotification('Você não tem permissão para alterar o status.', 'error');
      return;
    }
    const id = e.currentTarget.getAttribute('data-id');
    currentCallId = id;
    db.collection('calls').doc(id).get().then(doc => {
      if (doc.exists) {
        const data = doc.data();
        const sel = document.getElementById('new-status');
        if (sel && data.status) sel.value = data.status;
      }
      openStatusModal();
    }).catch(err => {
      showNotification(`Erro ao abrir chamado: ${err.message}`, 'error');
    });
  }

  async function changeCallStatus(callId, newStatus) {
    try {
      await db.collection('calls').doc(callId).update({ status: newStatus });
      if (newStatus === 'paid') {
        if (confirm('Deseja adicionar esta despesa como conta paga no controle financeiro?')) {
          showNotification('Despesa adicionada como conta paga!');
          // TODO: integrar com coleção de finanças (ex.: db.collection('contas').add({...}))
        }
      }
      showNotification('Status atualizado com sucesso!', 'success');
      closeStatusModal();
    } catch (error) {
      showNotification(`Erro: ${error.message}`, 'error');
    }
  }

  function openStatusModal() {
    statusModal.classList.remove('hidden');
    statusModal.style.display = 'flex';
    statusModal.setAttribute('aria-hidden', 'false');
  }
  function closeStatusModal() {
    statusModal.classList.add('hidden');
    statusModal.style.display = 'none';
    statusModal.setAttribute('aria-hidden', 'true');
    currentCallId = null;
  }

  // UI events
  createCallBtn.addEventListener('click', () => {
    const name = document.getElementById('call-name').value.trim();
    const category = document.getElementById('call-category').value;
    const value = document.getElementById('call-value').value.trim();
    const notes = document.getElementById('call-notes').value.trim();
    const priority = document.getElementById('call-priority').value;

    if (!name || !category || !value) {
      showNotification('Preencha nome, categoria e valor.', 'error');
      return;
    }
    createCall(name, category, value, notes, priority);
  });

  saveStatusBtn.addEventListener('click', () => {
    const newStatus = document.getElementById('new-status').value;
    if (currentCallId) changeCallStatus(currentCallId, newStatus);
  });
  cancelStatusBtn.addEventListener('click', closeStatusModal);

  // Click outside modal closes it
  statusModal.addEventListener('click', (e) => {
    if (e.target === statusModal) closeStatusModal();
  });

  // Menu toggle and logout initialization (moved out of snapshot)
  document.addEventListener('DOMContentLoaded', () => {
    const menuToggle = document.querySelector('.menu-toggle');
    const navLinks = document.querySelector('.nav-links');
    if (menuToggle && navLinks) {
      menuToggle.addEventListener('click', () => navLinks.classList.toggle('show'));
      document.querySelectorAll('.nav-links a').forEach(link => {
        link.addEventListener('click', () => { if (navLinks.classList.contains('show')) navLinks.classList.remove('show'); });
      });
    }

    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        auth.signOut().then(() => { window.location.href = 'index.html'; });
      });
    }
  });

  // Auth state - show admin menu item and load calls
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      db.collection('users').doc(user.uid).get().then(doc => {
        currentUserRole = doc.exists ? (doc.data().role || 'member') : 'member';
        // show/hide admin menu
        const adminMenuItem = document.getElementById('admin-menu-item');
        const userPhotoImg = document.getElementById('user-photo-img');
        if (currentUserRole === 'admin') {
          adminMenuItem.style.display = 'block';
        } else {
          adminMenuItem.style.display = 'none';
        }
        // set photo if present
        if (user.photoURL) userPhotoImg.src = user.photoURL;

        // Make sure new-call-section shown for authenticated users
        newCallSection.classList.remove('hidden');

        // load calls (will attempt realtime query and fallback if necessary)
        loadCalls();
      }).catch(err => {
        showNotification(`Erro ao verificar usuário: ${err.message}`, 'error');
      });
    } else {
      // not authenticated -> redirect
      window.location.href = 'index.html';
    }
  });

</script>
</body>
</html>