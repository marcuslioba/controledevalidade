<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Contas a Pagar — Dashboard</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#94a3b8;
      --accent:#6c5ce7;
      --green:#16a34a;
      --red:#ef4444;
      --glass: rgba(255,255,255,0.03);
      --radius:14px;
      font-family: 'Inter', system-ui, sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#071021 0%,#0b1220 100%);color:#e6eef8;min-height:100vh}
    .app{display:grid;grid-template-columns:260px 1fr;gap:20px;padding:20px;max-width:1200px;margin:24px auto}

    /* SIDEBAR */
    .sidebar{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:18px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#34d399);display:flex;align-items:center;justify-content:center;font-weight:700;color:white}
    .nav{display:flex;flex-direction:column;gap:6px}
    .nav button{background:transparent;border:0;color:var(--muted);text-align:left;padding:10px;border-radius:10px;display:flex;gap:10px;align-items:center;cursor:pointer}
    .nav button.active{background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));color:var(--accent)}

    /* MAIN */
    .main{padding:18px;border-radius:var(--radius);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 6px 30px rgba(3,6,23,0.6)}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    h1{margin:0;font-size:18px}

    /* grid cards */
    .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:18px}
    .card{background:var(--glass);padding:14px;border-radius:12px;box-shadow:0 3px 12px rgba(2,6,23,0.4)}
    .card .value{font-weight:700;font-size:18px}
    .card small{color:var(--muted)}

    /* mobile */
    @media (max-width:900px){.app{grid-template-columns:1fr;padding:12px}.cards{grid-template-columns:repeat(2,1fr)}.sidebar{display:flex;overflow:auto;flex-direction:row;gap:10px;padding:10px}}

    /* forms and lists */
    form{display:grid;gap:8px}
    input,select{padding:10px;border-radius:10px;border:0;background:rgba(255,255,255,0.03);color:inherit}
    .btn{padding:10px 12px;border-radius:10px;border:0;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#8b5cf6);color:#fff}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .list{display:flex;flex-direction:column;gap:8px}
    .list-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02)}
    .chip{padding:6px 8px;border-radius:999px;font-size:12px}
    .chip.in{background:rgba(22,163,74,0.12);color:var(--green)}
    .chip.out{background:rgba(239,68,68,0.08);color:var(--red)}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px}
    .actions button{border:0;background:transparent;color:var(--muted);cursor:pointer}
    .filters{display:flex;gap:8px;margin-bottom:8px}
    .filters button{padding:6px 10px;border-radius:999px;border:0;background:rgba(255,255,255,0.02);cursor:pointer}
    .toast{position:fixed;right:20px;bottom:20px;background:linear-gradient(90deg,#111827,#0b1220);padding:12px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.7);display:none}
    .toast.success{border-left:4px solid var(--green)}
    .toast.error{border-left:4px solid var(--red)}
    .hidden{display:none}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.02);font-size:14px}
  </style>
</head>
<body>

<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">CA</div>
      <div>
        <div style="font-weight:700">ContasApp</div>
        <div class="muted" style="font-size:12px">Financeiro simples</div>
      </div>
    </div>

    <nav class="nav" id="nav">
      <button class="active" data-tab="dashboard"><span class="material-icons">dashboard</span> Dashboard</button>
      <button data-tab="new"><span class="material-icons">add_circle</span> Cadastrar Conta</button>
      <button data-tab="upcoming"><span class="material-icons">schedule</span> Próximos Vencimentos</button>
      <button data-tab="categories"><span class="material-icons">category</span> Categorias</button>
    </nav>

    <div style="margin-top:18px" class="muted small">Dica: use filtros de 7/15/30 dias em Próximos Vencimentos.</div>
  </aside>

  <main class="main">
    <div class="topbar">
      <h1>Dashboard</h1>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn ghost" id="refreshBtn"><i class="fa fa-sync"></i> Atualizar</button>
        <button class="btn primary" id="openNew">+ Nova Conta</button>
      </div>
    </div>

    <section id="content">
      <!-- DASHBOARD VIEW -->
      <div id="dashboardView">
        <div class="cards">
          <div class="card">
            <div class="muted">Total de contas (mês)</div>
            <div class="value" id="totalMonth">R$ 0,00</div>
          </div>
          <div class="card">
            <div class="muted">Total entradas</div>
            <div class="value" id="totalIn">R$ 0,00</div>
          </div>
          <div class="card">
            <div class="muted">Total saídas</div>
            <div class="value" id="totalOut">R$ 0,00</div>
          </div>
          <div class="card" id="saldoCard" style="display:none">
            <div class="muted">Saldo do mês</div>
            <div class="value" id="saldo">R$ 0,00</div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 360px;gap:14px">
          <div class="card">
            <canvas id="chartArea" height="160"></canvas>
          </div>

          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div class="muted">Próximos Vencimentos</div>
              <div class="small muted">7 / 15 / 30 dias</div>
            </div>
            <div id="miniUpcoming" class="list"></div>
            <div style="margin-top:12px;text-align:right"><button class="btn ghost" data-tab="upcoming">Ver todos</button></div>
          </div>
        </div>

        <div style="margin-top:14px" class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div><h3 class="small">Todas as Contas</h3><div class="muted">Lista completa de contas</div></div>
          </div>

          <div id="allAccounts"></div>
        </div>
      </div>

      <!-- NEW ACCOUNT VIEW -->
      <div id="newView" style="display:none">
        <div class="card">
          <h2 class="small">Cadastrar Conta</h2>
          <form id="accountForm" aria-label="Formulário de conta">
            <input type="hidden" id="accountId" />
            <label for="nome">Nome</label>
            <input id="nome" required aria-required="true" />
            <label for="categoria">Categoria</label>
            <select id="categoria" aria-required="true"></select>
            <label for="valor">Valor</label>
            <input id="valor" type="number" step="0.01" required inputmode="decimal" aria-required="true" />
            <label for="vencimento">Vencimento</label>
            <input id="vencimento" type="date" required />
            <label for="tipo">Tipo</label>
            <select id="tipo"><option value="saida">Saída</option><option value="entrada">Entrada</option></select>

            <label for="status">Pagamento</label>
            <select id="status" aria-describedby="statusHelp"><option value="pendente">Agendar Pagamento</option><option value="pago">Pago</option></select>
            <div id="statusHelp" class="muted small">Escolha se já foi pago ou se deve ser agendado</div>

            <div id="repeatBlock" style="display:none">
              <label for="repeticao">Repetir mensalmente?</label>
              <select id="repeticao"><option value="nao">Não</option><option value="sim">Sim</option></select>
            </div>

            <div style="display:flex;gap:8px;margin-top:8px">
              <button type="submit" class="btn primary" id="saveBtn">Salvar</button>
              <button type="button" class="btn ghost" id="cancelEdit">Cancelar</button>
            </div>
          </form>
        </div>
      </div>

      <!-- UPCOMING VIEW -->
      <div id="upcomingView" style="display:none">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div>
              <h3 class="small">Próximos Vencimentos</h3>
              <div class="muted">Filtrar por intervalo</div>
            </div>
            <div class="filters">
              <button data-days="7" class="active">7 dias</button>
              <button data-days="15">15 dias</button>
              <button data-days="30">30 dias</button>
            </div>
          </div>

          <div id="upcomingList" class="list"></div>
        </div>
      </div>

      <!-- CATEGORIES VIEW -->
      <div id="categoriesView" style="display:none">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div><h3 class="small">Categorias</h3><div class="muted">Gerencie suas categorias</div></div>
            <div><button id="addCat" class="btn primary">+ Categoria</button></div>
          </div>

          <div id="categoriesList" class="list"></div>
        </div>
      </div>

    </section>
  </main>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ==== CONFIG ==== */
/* sua URL final do Web App */
const API = 'https://script.google.com/macros/s/AKfycbzcVyhC_ASf70QFf00rfGXyjFYo39kc12NRCNAQCXBAzRSSoR8cVHthBKc5Er4sz7Kt/exec';

/* ==== HELPERS ==== */
const $ = (s, p=document) => p.querySelector(s);
const fmt = num => Number(num||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const todayISO = ()=> new Date().toISOString().slice(0,10);

let accounts = [];
let categories = [];
let chart = null;
let currentFilterDays = 7;

/* Resolve nome da categoria com base em id ou nome recebido */
function getCategoryName(ref){
  if(!ref) return '';
  // se for id, procurar na lista de categorias
  const found = categories.find(c => String(c.id) === String(ref) || c.categoria === ref);
  return found ? found.categoria : ref;
}

/* ==== BOOT ==== */
document.addEventListener('DOMContentLoaded', () => {
  initNav();
  setupForm();
  bindUIButtons();
  loadAll();
});

/* NAV */
function initNav(){
  document.querySelectorAll('#nav button').forEach(b => {
    b.addEventListener('click', () => {
      document.querySelectorAll('#nav button').forEach(x => x.classList.remove('active'));
      b.classList.add('active');
      openTab(b.dataset.tab);
    });
  });
  // botões com data-tab (ex.: "Ver todos") também abrem
  document.querySelectorAll('[data-tab]').forEach(b=>b.addEventListener('click', ()=>openTab(b.dataset.tab)));
}
function openTab(tab){
  ['dashboard','new','upcoming','categories'].forEach(t=>{
    const el = document.getElementById(t + 'View');
    if(el) el.style.display = (t===tab ? 'block' : 'none');
  });
}

/* ==== API HELPERS (JSON + status check) ==== */
async function request(method='GET', url=API, body){
  const opts = { method, headers:{} };
  if(method !== 'GET'){
    opts.headers['Content-Type'] = 'application/json;charset=utf-8';
    opts.body = JSON.stringify(body);
  }
  const res = await fetch(url + (method==='GET' && body ? `?${body}` : ''), opts);
  if(!res.ok){
    const text = await res.text();
    throw new Error(`HTTP ${res.status}: ${text}`);
  }
  return res.json();
}
async function apiGet(params=''){ return request('GET', API, params); }
async function apiPost(body){ return request('POST', API, body); }
async function apiPut(body){ return request('PUT', API, body); }
async function apiDelete(body){ return request('DELETE', API, body); }

/* ==== LOAD & RENDER ==== */
async function loadAll(){
  showToast('Carregando dados...');
  try{
    const [contasResp, catsResp] = await Promise.all([
      apiGet('action=listarContas'),
      apiGet('action=listarCategorias')
    ]);
    accounts = Array.isArray(contasResp) ? contasResp : (contasResp && contasResp.contas) ? contasResp.contas : [];
    categories = Array.isArray(catsResp) ? catsResp : (catsResp && catsResp.categorias) ? catsResp.categorias : [];
    renderDashboard();
    renderCategories();
    renderUpcomingMini();
    renderAllAccounts();
    hideToast();
  }catch(err){
    showToast('Erro ao carregar: ' + (err.message || err), 4000, 'error');
  }
}

function renderDashboard(){
  const now = new Date();
  const month = now.getMonth();
  const year = now.getFullYear();
  const monthAccounts = accounts.filter(a=>{
    const d = new Date(a.vencimento);
    return d.getMonth()===month && d.getFullYear()===year;
  });

  const totalMonth = monthAccounts.reduce((s,a)=>s+Number(a.valor||0),0);
  const totalIn = monthAccounts.filter(a=>a.tipo==='entrada').reduce((s,a)=>s+Number(a.valor||0),0);
  const totalOut = monthAccounts.filter(a=>a.tipo==='saida').reduce((s,a)=>s+Number(a.valor||0),0);

  $('#totalMonth').textContent = fmt(totalMonth);
  $('#totalIn').textContent = fmt(totalIn);
  $('#totalOut').textContent = fmt(totalOut);

  const saldoCard = $('#saldoCard');
  if(accounts.length>0){
    saldoCard.style.display='block';
    $('#saldo').textContent = fmt(totalIn - totalOut);
  } else {
    saldoCard.style.display='none';
  }

  // chart
  const ctx = document.getElementById('chartArea');
  const labels = ['Entradas','Saídas'];
  const data = [totalIn,totalOut];
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type:'doughnut',
    data:{ labels, datasets:[{ data, backgroundColor:['#10B981','#EF4444'] }] },
    options:{ plugins:{ legend:{ labels:{ color:'#cbd5e1' } } } }
  });
}

function renderUpcomingMini(){
  const soon = getUpcoming(currentFilterDays).slice(0,6);
  const container = $('#miniUpcoming'); container.innerHTML='';
  if(soon.length===0){ container.innerHTML = '<div class="muted">Nenhum vencimento próximo</div>'; return; }
  soon.forEach(a=>{
    const div = document.createElement('div'); div.className='list-item';
    div.innerHTML = `<div><div style="font-weight:600">${escapeHTML(a.nome)}</div><div class="muted small">${escapeHTML(getCategoryName(a.categoriaId || a.categoria))} — ${formatDate(a.vencimento)}</div></div>
    <div style="text-align:right"><div class="chip ${a.tipo==='entrada'?'in':'out'}">${a.tipo}</div><div style="margin-top:8px"><button class="btn ghost payBtn" data-id="${a.id}">Marcar Pago</button></div></div>`;
    container.appendChild(div);
  });
}

function renderUpcomingList(days){
  const list = getUpcoming(days);
  const container = $('#upcomingList'); container.innerHTML='';
  if(list.length===0){ container.innerHTML = '<div class="muted">Nenhum vencimento neste intervalo</div>'; return; }
  list.forEach(a=>{
    const el = document.createElement('div'); el.className='list-item';
    el.innerHTML = `<div><div style="font-weight:600">${escapeHTML(a.nome)}</div><div class="muted small">${escapeHTML(getCategoryName(a.categoriaId || a.categoria))} — ${formatDate(a.vencimento)}</div></div>
    <div class="actions"><span class="chip ${a.tipo==='entrada'?'in':'out'}">${a.tipo}</span><div style="margin-top:8px">
      <button class="btn ghost editBtn" data-id="${a.id}">Editar</button>
      <button class="btn ghost delBtn" data-id="${a.id}">Excluir</button>
      <button class="btn primary payBtn" data-id="${a.id}">Marcar Pago</button>
    </div></div>`;
    container.appendChild(el);
  });
}

function renderCategories(){
  const sel = $('#categoria'); sel.innerHTML='';
  categories.forEach(c=>{
    const o = document.createElement('option');
    o.value = c.id;       // usar id
    o.textContent = c.categoria;
    sel.appendChild(o);
  });
  const list = $('#categoriesList'); list.innerHTML='';
  if(categories.length===0){ list.innerHTML = '<div class="muted">Sem categorias</div>'; return; }
  categories.forEach(c=>{
    const row = document.createElement('div'); row.className='list-item';
    row.innerHTML = `<div>${escapeHTML(c.categoria)}</div><div><button class="btn ghost editCatBtn" data-id="${c.id}">Editar</button><button class="btn ghost delCatBtn" data-id="${c.id}">Excluir</button></div>`;
    list.appendChild(row);
  });
}

function renderAllAccounts(){
  const container = $('#allAccounts'); container.innerHTML='';
  if(accounts.length===0){ container.innerHTML = '<div class="muted">Nenhuma conta cadastrada</div>'; return; }
  const table = document.createElement('table'); table.className='table';
  table.innerHTML = `<thead><tr><th>Nome</th><th>Categoria</th><th>Vencimento</th><th>Valor</th><th>Tipo</th><th>Status</th><th></th></tr></thead>`;
  const tbody = document.createElement('tbody');
  accounts.forEach(a=>{
    const tr = document.createElement('tr');
    const catName = escapeHTML(getCategoryName(a.categoriaId || a.categoria));
    tr.innerHTML = `<td>${escapeHTML(a.nome)}</td>
    <td>${catName}</td>
    <td>${formatDate(a.vencimento)}</td>
    <td>${fmt(a.valor)}</td>
    <td><span class="chip ${a.tipo==='entrada'?'in':'out'}">${a.tipo}</span></td>
    <td class="muted">${a.status||'pendente'}</td>
    <td>
      <button class="btn ghost editBtn" data-id="${a.id}">Editar</button>
      <button class="btn ghost delBtn" data-id="${a.id}">Excluir</button>
      <button class="btn primary payBtn" data-id="${a.id}">Marcar Pago</button>
    </td>`;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}

/* ==== FORM ==== */
function setupForm(){
  $('#status').addEventListener('change', ()=> {
    $('#repeatBlock').style.display = $('#status').value === 'pendente' ? 'block' : 'none';
  });

  $('#accountForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const saveBtn = $('#saveBtn');
    saveBtn.disabled = true;
    const categoriaId = $('#categoria').value;
    const categoriaNome = getCategoryName(categoriaId);

    const data = {
      action: $('#accountId').value ? 'editarConta' : 'cadastrarConta',
      id: $('#accountId').value || undefined,
      nome: $('#nome').value.trim(),
      categoriaId: categoriaId,
      categoriaNome: categoriaNome,
      valor: Number($('#valor').value || 0),
      vencimento: $('#vencimento').value,
      tipo: $('#tipo').value,
      status: $('#status').value,
      repeticao: $('#repeticao').value
    };
    try{
      showToast('Salvando...');
      if(data.action === 'cadastrarConta'){
        await apiPost(data);
      } else {
        await apiPut(data);
      }
      await loadAll();
      openTab('dashboard');
      showToast('Conta salva com sucesso!', 2500, 'success');
    }catch(err){
      showToast('Erro ao salvar: ' + (err.message||err), 4000, 'error');
    } finally {
      saveBtn.disabled = false;
    }
  });

  document.getElementById('cancelEdit').addEventListener('click', ()=> openTab('dashboard'));
}

/* ==== ACTIONS ==== */
function bindUIButtons(){
  document.getElementById('openNew').addEventListener('click', ()=> { openTab('new'); clearForm(); });
  document.getElementById('refreshBtn').addEventListener('click', loadAll);

  document.querySelectorAll('.filters button').forEach(b=>{
    b.addEventListener('click', ()=> {
      document.querySelectorAll('.filters button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      currentFilterDays = Number(b.dataset.days);
      renderUpcomingList(currentFilterDays);
    });
  });

  document.getElementById('addCat').addEventListener('click', async ()=>{
    const name = prompt('Nome da categoria:');
    if(!name) return;
    try{
      await apiPost({ action: 'cadastrarCategoria', categoria: name });
      await loadAll();
      showToast('Categoria criada', 2000, 'success');
    }catch(err){ showToast('Erro: ' + (err.message||err), 3500, 'error'); }
  });

  // delegação para ações nas listas/tabela
  document.getElementById('allAccounts').addEventListener('click', (e)=>{
    const id = e.target.dataset?.id;
    if(!id) return;
    if(e.target.classList.contains('editBtn')) openEdit(id);
    if(e.target.classList.contains('delBtn')) {
      if(confirm('Deseja excluir esta conta?')) confirmDelete(id);
    }
    if(e.target.classList.contains('payBtn')) {
      if(confirm('Marcar esta conta como PAGO?')) markPaid(id);
    }
  });

  document.getElementById('miniUpcoming').addEventListener('click', (e)=>{
    const id = e.target.dataset?.id;
    if(!id) return;
    if(e.target.classList.contains('payBtn')) {
      if(confirm('Marcar esta conta como PAGO?')) markPaid(id);
    }
  });

  document.getElementById('categoriesList').addEventListener('click', (e)=>{
    const id = e.target.dataset?.id;
    if(!id) return;
    if(e.target.classList.contains('editCatBtn')) editCategory(id);
    if(e.target.classList.contains('delCatBtn')) {
      if(confirm('Excluir categoria?')) deleteCategory(id);
    }
  });
}

async function markPaid(id){
  try{
    await apiPut({ action:'marcarPago', id });
    await loadAll();
    showToast('Pagamento registrado!', 2500, 'success');
  }catch(err){ showToast('Erro: ' + (err.message||err), 3500, 'error'); }
}

async function openEdit(id){
  const a = accounts.find(x=>String(x.id)===String(id));
  if(!a) return showToast('Conta não encontrada', 2500, 'error');
  openTab('new');
  $('#accountId').value = a.id;
  $('#nome').value = a.nome;
  // preencher categoria (aceita categoriaId ou categoria)
  $('#categoria').value = a.categoriaId || a.categoria || '';
  $('#valor').value = a.valor;
  const d = new Date(a.vencimento);
  $('#vencimento').value = isNaN(d) ? a.vencimento : d.toISOString().slice(0,10);
  $('#tipo').value = a.tipo || 'saida';
  $('#status').value = a.status || 'pendente';
  $('#repeticao').value = a.repeticao || 'nao';
  $('#repeatBlock').style.display = $('#status').value==='pendente' ? 'block':'none';
}

async function confirmDelete(id){
  try{
    await apiDelete({ action:'deletarConta', id });
    await loadAll();
    showToast('Conta excluída', 2500, 'success');
  }catch(err){ showToast('Erro: ' + (err.message||err), 3500, 'error'); }
}

/* ==== CATEGORIES ==== */
function editCategory(id){
  const c = categories.find(x=>String(x.id)===String(id));
  if(!c) return showToast('Categoria não encontrada', 2500, 'error');
  const name = prompt('Editar categoria', c.categoria);
  if(!name) return;
  apiPut({ action:'editarCategoria', id: c.id, categoria: name }).then(()=>loadAll()).catch(err=>showToast('Erro: ' + (err.message||err), 3500, 'error'));
}
function deleteCategory(id){
  apiDelete({ action:'deletarCategoria', id }).then(()=>loadAll()).catch(err=>showToast('Erro: ' + (err.message||err), 3500, 'error'));
}

/* ==== UTIL ==== */
function getUpcoming(days){
  const now = new Date(); now.setHours(0,0,0,0);
  const end = new Date(now.getTime() + days * 86400000); // CORRIGIDO: 86400000 ms = 1 dia
  return accounts.filter(a=>{
    if(!a.vencimento) return false;
    if(String(a.status).toLowerCase() === 'pago') return false;
    const d = new Date(a.vencimento); d.setHours(0,0,0,0);
    return d >= now && d <= end;
  }).sort((x,y)=>new Date(x.vencimento)-new Date(y.vencimento));
}
function formatDate(d){ if(!d) return '-'; const dt = new Date(d); if(isNaN(dt)) return d; return dt.toLocaleDateString('pt-BR'); }
function escapeHTML(str){ if(!str && str!==0) return ''; return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[s]); }
function clearForm(){ $('#accountId').value=''; $('#nome').value=''; $('#valor').value=''; $('#vencimento').value = todayISO(); $('#tipo').value='saida'; $('#status').value='pendente'; $('#repeticao').value='nao'; $('#repeatBlock').style.display='block'; }

function showToast(msg, time=2500, type='info'){
  const t = $('#toast');
  t.className = 'toast';
  if(type === 'success') t.classList.add('success');
  if(type === 'error') t.classList.add('error');
  t.style.display='block';
  t.textContent=msg;
  clearTimeout(t._to);
  t._to = setTimeout(()=>t.style.display='none', time);
}
function hideToast(){ $('#toast').style.display='none' }
</script>

</body>
</html>
