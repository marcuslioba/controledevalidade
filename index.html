<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checklist com Selfie, Geofence e Relatório</title>
  <meta name="description" content="Checklist com selfie, geolocalização, geofence, evidências por item e relatório em PDF." />

  <!-- Tailwind CSS (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Font Awesome (ícones) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- React 17 + Babel -->
  <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    @media print {
      .print\:hidden { display: none !important; }
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    function App() {
      // ----------------- Estado principal -----------------
      const [perguntas, setPerguntas] = React.useState([
        'Você verificou os equipamentos?',
        'Você seguiu os procedimentos de segurança?',
        'Você completou a documentação necessária?'
      ]);
      const [novaPergunta, setNovaPergunta] = React.useState('');
      const [editandoIndex, setEditandoIndex] = React.useState(null);
      const [textoEdicao, setTextoEdicao] = React.useState('');
      const [checklistIniciado, setChecklistIniciado] = React.useState(false);
      const [checklistFinalizado, setChecklistFinalizado] = React.useState(false);

      // Selfie
      const [selfie, setSelfie] = React.useState(null);
      const videoRef = React.useRef(null);
      const canvasRef = React.useRef(null);
      const [cameraAtiva, setCameraAtiva] = React.useState(false);

      // Geolocalização e Geofence
      const [geoStatus, setGeoStatus] = React.useState('idle'); // idle | buscando | ok | erro
      const [coords, setCoords] = React.useState(null); // { latitude, longitude, accuracy }
      const [endereco, setEndereco] = React.useState('');
      const [geoErro, setGeoErro] = React.useState('');

      const [alvoLat, setAlvoLat] = React.useState('');
      const [alvoLon, setAlvoLon] = React.useState('');
      const [alvoRaio, setAlvoRaio] = React.useState(100); // metros
      const [distancia, setDistancia] = React.useState(null);
      const [dentroDaArea, setDentroDaArea] = React.useState(false);

      // Respostas e evidências
      const [respostas, setRespostas] = React.useState({}); // { index: 'sim'|'nao' }
      const [evidencias, setEvidencias] = React.useState({}); // { index: dataURL }

      // Tempo
      const [inicioISO, setInicioISO] = React.useState(null);
      const [fimISO, setFimISO] = React.useState(null);

      // Upload CSV
      const [uploadErro, setUploadErro] = React.useState('');

      // ----------------- Utilidades -----------------
      const formatarDataHora = (iso) => {
        if (!iso) return '';
        const d = new Date(iso);
        return d.toLocaleString();
      };

      const duracaoHumana = (ms) => {
        if (!ms || ms < 0) return '';
        const s = Math.floor(ms / 1000);
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const seg = s % 60;
        const partes = [];
        if (h) partes.push(h + 'h');
        if (m || h) partes.push(m + 'm');
        partes.push(seg + 's');
        return partes.join(' ');
      };

      const toRad = (deg) => (deg * Math.PI) / 180;
      const haversineMeters = (lat1, lon1, lat2, lon2) => {
        const R = 6371000;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
          Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      };

      // ----------------- Câmera/Selfie -----------------
      const ativarCamera = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          if (videoRef.current) {
            videoRef.current.srcObject = stream;
            setCameraAtiva(true);
          }
        } catch (err) {
          alert('Erro ao acessar a câmera: ' + err.message);
        }
      };

      const tirarSelfie = () => {
        const canvas = canvasRef.current;
        const video = videoRef.current;
        if (canvas && video) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          canvas.getContext('2d').drawImage(video, 0, 0);
          const imagemData = canvas.toDataURL('image/png');
          setSelfie(imagemData);
          const stream = video.srcObject;
          if (stream) stream.getTracks().forEach((t) => t.stop());
          setCameraAtiva(false);
        }
      };

      // ----------------- Geolocalização -----------------
      const capturarLocalizacao = () => {
        setGeoErro('');
        if (!('geolocation' in navigator)) {
          setGeoStatus('erro');
          setGeoErro('Geolocalização não suportada no navegador.');
          return;
        }
        setGeoStatus('buscando');
        navigator.geolocation.getCurrentPosition(
          async (pos) => {
            const { latitude, longitude, accuracy } = pos.coords;
            const c = { latitude, longitude, accuracy };
            setCoords(c);
            setGeoStatus('ok');

            if (alvoLat && alvoLon) {
              const d = haversineMeters(
                parseFloat(latitude),
                parseFloat(longitude),
                parseFloat(alvoLat),
                parseFloat(alvoLon)
              );
              setDistancia(d);
              setDentroDaArea(d <= (parseFloat(alvoRaio) || 0));
            }

            try {
              const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`;
              const resp = await fetch(url, { headers: { 'Accept-Language': 'pt-BR' } });
              if (resp.ok) {
                const data = await resp.json();
                setEndereco(data.display_name || '');
              }
            } catch (e) {}
          },
          (err) => {
            setGeoStatus('erro');
            setGeoErro(err.message || 'Falha ao obter localização.');
          },
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      };

      const validarGeofence = () => {
        if (!coords || !alvoLat || !alvoLon) return;
        const d = haversineMeters(
          parseFloat(coords.latitude),
          parseFloat(coords.longitude),
          parseFloat(alvoLat),
          parseFloat(alvoLon)
        );
        setDistancia(d);
        setDentroDaArea(d <= (parseFloat(alvoRaio) || 0));
      };

      const StaticMap = ({ lat, lon }) => {
        if (!lat || !lon) return null;
        const marker = `&markers=${lat},${lon},lightblue1`;
        const src = `https://staticmap.openstreetmap.de/staticmap.php?center=${lat},${lon}&zoom=16&size=600x300&maptype=mapnik${marker}`;
        return (
          <div className="rounded overflow-hidden border">
            <img src={src} alt="Mapa de check-in" className="w-full" />
            <div className="text-xs text-gray-600 p-2">Fonte: OpenStreetMap</div>
          </div>
        );
      };

      // ----------------- Perguntas -----------------
      const adicionarPergunta = () => {
        if (novaPergunta.trim()) {
          setPerguntas((p) => [...p, novaPergunta.trim()]);
          setNovaPergunta('');
        }
      };
      const removerPergunta = (index) => {
        setPerguntas(perguntas.filter((_, i) => i !== index));
      };
      const iniciarEdicao = (index) => {
        setEditandoIndex(index);
        setTextoEdicao(perguntas[index]);
      };
      const salvarEdicao = () => {
        const novasPerguntas = [...perguntas];
        novasPerguntas[editandoIndex] = textoEdicao;
        setPerguntas(novasPerguntas);
        setEditandoIndex(null);
        setTextoEdicao('');
      };

      // Evidências
      const handleEvidenciaUpload = (index, file) => {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          setEvidencias((ev) => ({ ...ev, [index]: e.target.result }));
        };
        reader.readAsDataURL(file);
      };

      // ----------------- Fluxo -----------------
      const iniciarChecklist = () => {
        if (!selfie) {
          alert('Tire uma selfie antes de iniciar o checklist.');
          return;
        }
        if (!coords) {
          alert('Capture a localização (GPS) antes de iniciar o checklist.');
          return;
        }
        if (!dentroDaArea) {
          alert('Você não está dentro da área permitida para este check-in.');
          return;
        }
        setChecklistIniciado(true);
        setRespostas({});
        setInicioISO(new Date().toISOString());
        setFimISO(null);
      };

      const responderPergunta = (index, resposta) => {
        setRespostas({ ...respostas, [index]: resposta });
      };

      const todasRespondidas = perguntas.every((_, index) => respostas[index]);
      const todasEvidencias = perguntas.every((_, index) => evidencias[index]);

      const finalizarChecklist = () => {
        if (!todasRespondidas) {
          alert('Responda todas as perguntas.');
          return;
        }
        if (!todasEvidencias) {
          alert('Anexe/registre foto de evidência para todos os itens.');
          return;
        }
        setFimISO(new Date().toISOString());
        setChecklistFinalizado(true);
      };

      const calcularNota = () => {
        const totalPerguntas = perguntas.length;
        const respostasPositivas = Object.values(respostas).filter((r) => r === 'sim').length;
        return totalPerguntas > 0 ? ((respostasPositivas / totalPerguntas) * 10).toFixed(1) : '0.0';
      };

      const reiniciar = () => {
        setChecklistIniciado(false);
        setChecklistFinalizado(false);
        setSelfie(null);
        setRespostas({});
        setEvidencias({});
        setCoords(null);
        setEndereco('');
        setGeoStatus('idle');
        setGeoErro('');
        setDistancia(null);
        setDentroDaArea(false);
        setInicioISO(null);
        setFimISO(null);
      };

      // ------- Importação via CSV (Excel -> Salvar como CSV) -------
      const detectarDelimitador = (text) => {
        const primeiroBloco = text.split(/\r?\n/).slice(0, 5).join('\n');
        const contaPontoEVirgula = (primeiroBloco.match(/;/g) || []).length;
        const contaVirgula = (primeiroBloco.match(/,/g) || []).length;
        const contaTab = (primeiroBloco.match(/\t/g) || []).length;
        if (contaPontoEVirgula >= contaVirgula && contaPontoEVirgula >= contaTab) return ';';
        if (contaVirgula >= contaPontoEVirgula && contaVirgula >= contaTab) return ',';
        return '\t';
      };

      const parseCSV = (text) => {
        const linhas = text.split(/\r?\n/).map((l) => l.trim()).filter((l) => l.length > 0);
        if (linhas.length === 0) return [];
        const delim = detectarDelimitador(text);
        const possivelCabecalho = linhas[0].split(delim).map((c) => c.trim().toLowerCase());
        const temCabecalhoPergunta = possivelCabecalho.some((h) => ['pergunta', 'perguntas', 'question', 'questions', 'item'].includes(h));
        const start = temCabecalhoPergunta ? 1 : 0;
        const lista = [];
        for (let i = start; i < linhas.length; i++) {
          const cols = linhas[i].split(delim).map((c) => c.trim());
          const cell = cols.find((c) => c.length > 0);
          if (cell) lista.push(cell);
        }
        return Array.from(new Set(lista));
      };

      const handleArquivoCSV = (file) => {
        setUploadErro('');
        if (!file) return;
        const isCSV = file.name.toLowerCase().endsWith('.csv');
        if (!isCSV) {
          setUploadErro('Formato não suportado. Por favor, exporte seu Excel como CSV (.csv).');
          return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const text = e.target.result;
            const novas = parseCSV(text);
            if (novas.length === 0) {
              setUploadErro('Não foram encontradas perguntas no arquivo. Verifique se há uma coluna com as perguntas.');
              return;
            }
            setPerguntas(novas);
            setRespostas({});
            setEvidencias({});
          } catch (err) {
            setUploadErro('Falha ao processar o arquivo CSV. Erro: ' + err.message);
          }
        };
        reader.readAsText(file, 'utf-8');
      };

      const baixarModeloCSV = () => {
        const linhas = ['pergunta', 'Item 1 está conforme?', 'Item 2 foi verificado?', 'EPIs conferidos?'];
        const csv = linhas.join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'modelo_perguntas_checklist.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      // ----------------- Telas -----------------
      if (checklistFinalizado) {
        const nota = calcularNota();
        const totalPerguntas = perguntas.length;
        const respostasPositivas = Object.values(respostas).filter((r) => r === 'sim').length;
        const duracao = inicioISO && fimISO ? duracaoHumana(new Date(fimISO) - new Date(inicioISO)) : '';

        return (
          <div className="min-h-screen bg-gradient-to-br from-green-400 to-blue-500 p-8 print:bg-white">
            <div className="max-w-3xl mx-auto bg-white rounded-lg shadow-2xl p-8 print:shadow-none">
              <h1 className="text-3xl font-bold text-center mb-6 text-green-600">
                <i className="fas fa-file-alt mr-2"></i>Relatório do Checklist
              </h1>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div className="text-center">
                  {selfie && (
                    <img src={selfie} alt="Selfie" className="w-32 h-32 rounded-full mx-auto border-4 border-green-500" />
                  )}
                  <div className="text-xs text-gray-600 mt-2">Selfie do check-in</div>
                </div>
                <div className="md:col-span-2 text-sm text-gray-700">
                  <div><strong>Início:</strong> {formatarDataHora(inicioISO)}</div>
                  <div><strong>Término:</strong> {formatarDataHora(fimISO)}</div>
                  <div><strong>Duração:</strong> {duracao}</div>
                  {coords && (
                    <div className="mt-2">
                      <div><strong>Latitude:</strong> {coords.latitude.toFixed(6)} | <strong>Longitude:</strong> {coords.longitude.toFixed(6)}</div>
                      {coords.accuracy && (<div><strong>Precisão:</strong> ±{Math.round(coords.accuracy)} m</div>)}
                      {endereco && (<div><strong>Endereço (aprox.):</strong> {endereco}</div>)}
                      {distancia != null && (
                        <div>
                          <strong>Distância ao alvo:</strong> {Math.round(distancia)} m | <strong>Status:</strong> {dentroDaArea ? 'Dentro da área' : 'Fora da área'}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>

              {coords && (
                <div className="mb-6">
                  <StaticMap lat={coords.latitude} lon={coords.longitude} />
                </div>
              )}

              <div className="bg-green-50 rounded-lg p-6 mb-6 text-center">
                <h2 className="text-5xl font-bold text-green-600 mb-2">{nota}</h2>
                <p className="text-gray-600">Nota Final — {respostasPositivas} de {totalPerguntas} respostas positivas</p>
              </div>

              <div className="mb-6">
                <h3 className="font-bold text-lg mb-3">Resumo das Respostas e Evidências</h3>
                {perguntas.map((pergunta, index) => (
                  <div key={index} className="p-3 bg-gray-50 rounded mb-2">
                    <div className="flex items-start justify-between gap-4">
                      <div className="flex-1">
                        <div className="text-sm font-semibold mb-1">{index + 1}. {pergunta}</div>
                        <div className={`text-sm font-bold ${respostas[index] === 'sim' ? 'text-green-600' : 'text-red-600'}`}>
                          {respostas[index] === 'sim' ? '✓ SIM' : '✗ NÃO'}
                        </div>
                      </div>
                      <div className="w-40 text-center">
                        {evidencias[index] ? (
                          <img src={evidencias[index]} alt={`Evidência ${index + 1}`} className="w-40 h-28 object-cover rounded border" />
                        ) : (
                          <div className="text-xs text-gray-500">Sem evidência</div>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>

              <div className="flex gap-3 print:hidden">
                <button
                  onClick={() => window.print()}
                  className="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition"
                >
                  <i className="fas fa-print mr-2"></i>Imprimir / Salvar em PDF
                </button>
                <button
                  onClick={reiniciar}
                  className="flex-1 bg-blue-500 text-white py-3 rounded-lg font-bold hover:bg-blue-600 transition"
                >
                  <i className="fas fa-redo mr-2"></i>Novo Checklist
                </button>
              </div>
            </div>
          </div>
        );
      }

      if (checklistIniciado) {
        const todasRespondidas = perguntas.every((_, index) => respostas[index]);
        const todasEvidencias = perguntas.every((_, index) => evidencias[index]);

        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-400 to-pink-500 p-8">
            <div className="max-w-3xl mx-auto bg-white rounded-lg shadow-2xl p-8">
              <h1 className="text-3xl font-bold text-center mb-6 text-purple-600">
                <i className="fas fa-clipboard-check mr-2"></i>Checklist em Andamento
              </h1>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                {selfie && (
                  <div className="text-center">
                    <img src={selfie} alt="Selfie" className="w-24 h-24 rounded-full mx-auto border-4 border-purple-500" />
                    <div className="text-xs text-gray-500 mt-1">Selfie</div>
                  </div>
                )}
                {coords && (
                  <div>
                    <div className="text-xs text-gray-700 mb-2">
                      <div><strong>Lat:</strong> {coords.latitude.toFixed(6)} | <strong>Lon:</strong> {coords.longitude.toFixed(6)}</div>
                      {endereco && (<div className="mt-1"><strong>Endereço:</strong> {endereco}</div>)}
                    </div>
                    <StaticMap lat={coords.latitude} lon={coords.longitude} />
                  </div>
                )}
              </div>

              <div className="space-y-4 mb-6">
                {perguntas.map((pergunta, index) => (
                  <div key={index} className="bg-gray-50 p-4 rounded-lg">
                    <p className="font-semibold mb-3">{index + 1}. {pergunta}</p>
                    <div className="flex flex-col md:flex-row gap-3 items-stretch md:items-center">
                      <div className="flex-1 flex gap-3">
                        <button
                          onClick={() => responderPergunta(index, 'sim')}
                          className={`flex-1 py-2 rounded-lg font-bold transition ${
                            respostas[index] === 'sim'
                              ? 'bg-green-500 text-white'
                              : 'bg-gray-200 text-gray-700 hover:bg-green-100'
                          }`}
                        >
                          <i className="fas fa-check mr-2"></i>SIM
                        </button>
                        <button
                          onClick={() => responderPergunta(index, 'nao')}
                          className={`flex-1 py-2 rounded-lg font-bold transition ${
                            respostas[index] === 'nao'
                              ? 'bg-red-500 text-white'
                              : 'bg-gray-200 text-gray-700 hover:bg-red-100'
                          }`}
                        >
                          <i className="fas fa-times mr-2"></i>NÃO
                        </button>
                      </div>
                      <div className="flex items-center gap-2">
                        <label className="text-xs text-gray-600">Foto de evidência:</label>
                        <input type="file" accept="image/*" onChange={(e) => handleEvidenciaUpload(index, e.target.files[0])} />
                        {evidencias[index] && <span className="text-green-600 text-xs"><i className="fas fa-check mr-1"></i>Anexada</span>}
                      </div>
                    </div>
                  </div>
                ))}
              </div>

              <button
                onClick={finalizarChecklist}
                disabled={!todasRespondidas || !todasEvidencias}
                className={`w-full py-3 rounded-lg font-bold transition ${
                  (todasRespondidas && todasEvidencias)
                    ? 'bg-purple-500 text-white hover:bg-purple-600'
                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                }`}
              >
                <i className="fas fa-flag-checkered mr-2"></i>Finalizar e Gerar Relatório
              </button>
            </div>
          </div>
        );
      }

      // Tela inicial
      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-400 to-purple-500 p-8">
          <div className="max-w-5xl mx-auto bg-white rounded-lg shadow-2xl p-8">
            <h1 className="text-4xl font-bold text-center mb-8 text-blue-600">
              <i className="fas fa-tasks mr-3"></i>Ferramenta de Checklist
            </h1>

            <div className="mb-8 bg-blue-50 p-6 rounded-lg">
              <h2 className="text-2xl font-bold mb-4 text-blue-700">
                <i className="fas fa-camera mr-2"></i>1. Check-in: Selfie e Localização
              </h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  {!selfie ? (
                    <div>
                      {!cameraAtiva ? (
                        <button
                          onClick={ativarCamera}
                          className="w-full bg-blue-500 text-white py-3 rounded-lg font-bold hover:bg-blue-600 transition"
                        >
                          <i className="fas fa-camera mr-2"></i>Ativar Câmera
                        </button>
                      ) : (
                        <div className="text-center">
                          <video ref={videoRef} autoPlay className="w-full max-w-md mx-auto rounded-lg mb-4"></video>
                          <button
                            onClick={tirarSelfie}
                            className="bg-green-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-600 transition"
                          >
                            <i className="fas fa-camera mr-2"></i>Tirar Selfie
                          </button>
                        </div>
                      )}
                      <canvas ref={canvasRef} className="hidden"></canvas>
                    </div>
                  ) : (
                    <div className="text-center">
                      <img src={selfie} alt="Selfie" className="w-48 h-48 rounded-full mx-auto mb-4 border-4 border-green-500" />
                      <p className="text-green-600 font-bold mb-2">
                        <i className="fas fa-check-circle mr-2"></i>Selfie capturada!
                      </p>
                      <button
                        onClick={() => setSelfie(null)}
                        className="text-red-500 hover:text-red-700 font-semibold"
                      >
                        <i className="fas fa-redo mr-2"></i>Tirar outra foto
                      </button>
                    </div>
                  )}
                </div>

                <div>
                  <div className="flex items-center gap-2 mb-3">
                    <button
                      onClick={capturarLocalizacao}
                      className="bg-indigo-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-600 transition"
                    >
                      <i className="fas fa-location-arrow mr-2"></i>Capturar Localização
                    </button>
                    {geoStatus === 'buscando' && (
                      <span className="text-sm text-gray-600 animate-pulse">Buscando…</span>
                    )}
                    {geoStatus === 'ok' && (
                      <span className="text-sm text-green-600"><i className="fas fa-check-circle mr-1"></i>Capturada</span>
                    )}
                  </div>

                  <div className="grid grid-cols-3 gap-2 mb-2">
                    <input type="number" step="any" placeholder="Lat alvo" value={alvoLat} onChange={(e) => setAlvoLat(e.target.value)} className="px-2 py-2 border rounded" />
                    <input type="number" step="any" placeholder="Lon alvo" value={alvoLon} onChange={(e) => setAlvoLon(e.target.value)} className="px-2 py-2 border rounded" />
                    <input type="number" placeholder="Raio (m)" value={alvoRaio} onChange={(e) => setAlvoRaio(e.target.value)} className="px-2 py-2 border rounded" />
                  </div>
                  <div className="flex gap-2 mb-3">
                    <button onClick={validarGeofence} className="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300 text-sm">Validar Geofence</button>
                    {distancia != null && (
                      <div className={`text-sm font-semibold ${dentroDaArea ? 'text-green-600' : 'text-red-600'}`}>
                        Distância: {Math.round(distancia)} m — {dentroDaArea ? 'Dentro' : 'Fora'} da área
                      </div>
                    )}
                  </div>

                  {coords && (
                    <div>
                      <div className="text-xs text-gray-700 mb-2">
                        <div><strong>Lat atual:</strong> {coords.latitude.toFixed(6)} | <strong>Lon atual:</strong> {coords.longitude.toFixed(6)}</div>
                        {coords.accuracy && (<div><strong>Precisão:</strong> ±{Math.round(coords.accuracy)} m</div>)}
                        {endereco && (<div className="mt-1"><strong>Endereço (aprox.):</strong> {endereco}</div>)}
                      </div>
                      <StaticMap lat={coords.latitude} lon={coords.longitude} />
                    </div>
                  )}
                </div>
              </div>
            </div>

            <div className="mb-8 bg-purple-50 p-6 rounded-lg">
              <h2 className="text-2xl font-bold mb-1 text-purple-700">
                <i className="fas fa-edit mr-2"></i>2. Gerenciar Perguntas
              </h2>
              <p className="text-sm text-gray-600 mb-4">Dica: para usar Excel, salve sua planilha como CSV (Arquivo → Salvar como → CSV UTF-8) e importe abaixo.</p>

              <div className="flex flex-col md:flex-row gap-3 mb-4 items-stretch md:items-center">
                <div className="flex-1 flex gap-2">
                  <input
                    type="text"
                    value={novaPergunta}
                    onChange={(e) => setNovaPergunta(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && adicionarPergunta()}
                    placeholder="Digite uma nova pergunta..."
                    className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                  />
                  <button
                    onClick={adicionarPergunta}
                    className="bg-purple-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-purple-600 transition"
                  >
                    <i className="fas fa-plus mr-2"></i>Adicionar
                  </button>
                </div>
                <div className="flex items-center gap-2">
                  <input
                    type="file"
                    accept=".csv"
                    onChange={(e) => handleArquivoCSV(e.target.files[0])}
                    className="block text-sm"
                    title="Importar perguntas (CSV)"
                  />
                  <button
                    onClick={baixarModeloCSV}
                    className="text-purple-600 hover:text-purple-800 underline text-sm"
                    title="Baixar modelo CSV"
                  >
                    Baixar modelo CSV
                  </button>
                </div>
              </div>

              {uploadErro && (
                <div className="bg-red-50 text-red-700 p-3 rounded mb-3 text-sm">
                  <i className="fas fa-exclamation-triangle mr-2"></i>{uploadErro}
                </div>
              )}

              <div className="space-y-2">
                {perguntas.map((pergunta, index) => (
                  <div key={index} className="flex items-center gap-2 bg-white p-3 rounded-lg shadow">
                    {editandoIndex === index ? (
                      <>
                        <input
                          type="text"
                          value={textoEdicao}
                          onChange={(e) => setTextoEdicao(e.target.value)}
                          className="flex-1 px-3 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-purple-500"
                        />
                        <button
                          onClick={salvarEdicao}
                          className="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600"
                        >
                          <i className="fas fa-check"></i>
                        </button>
                        <button
                          onClick={() => setEditandoIndex(null)}
                          className="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600"
                        >
                          <i className="fas fa-times"></i>
                        </button>
                      </>
                    ) : (
                      <>
                        <span className="flex-1">{pergunta}</span>
                        <button
                          onClick={() => iniciarEdicao(index)}
                          className="text-blue-500 hover:text-blue-700 px-2"
                        >
                          <i className="fas fa-edit"></i>
                        </button>
                        <button
                          onClick={() => removerPergunta(index)}
                          className="text-red-500 hover:text-red-700 px-2"
                        >
                          <i className="fas fa-trash"></i>
                        </button>
                      </>
                    )}
                  </div>
                ))}
              </div>
            </div>

            <button
              onClick={iniciarChecklist}
              disabled={!selfie || !coords || !dentroDaArea || perguntas.length === 0}
              className={`w-full py-4 rounded-lg font-bold text-lg transition ${
                selfie && coords && dentroDaArea && perguntas.length > 0
                  ? 'bg-green-500 text-white hover:bg-green-600'
                  : 'bg-gray-300 text-gray-500 cursor-not-allowed'
              }`}
            >
              <i className="fas fa-play-circle mr-2"></i>Iniciar Checklist
            </button>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
