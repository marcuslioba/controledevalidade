<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsychoPro | Gestão de Consultório</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        // =========================================================================
        // === CONFIGURAÇÕES DO FIREBASE (FORNECIDAS PELO USUÁRIO) ===
        // =========================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDTjGnO9D4fljHA0ucTBujw_n1PSAFatkE",
            authDomain: "studio-873001119-21845.firebaseapp.com",
            projectId: "studio-873001119-21845",
            storageBucket: "studio-873001119-21845.firebasestorage.app",
            messagingSenderId: "842279750292",
            appId: "1:842279750292:web:62583e78f06ca68a6e0281"
        };
        
        const appId = firebaseConfig.appId;
        const initialAuthToken = null; 

        let app, db, auth, storage, userId;
        const state = {
            currentView: 'dashboard', // dashboard, patients, agenda, finance, documents
            patients: [],
            appointments: [],
            finances: [],
            activePatient: null, // Patient object for detail view
            isAuthReady: false
        };

        // --- UTILS ---

        // Helper para formatar data e hora
        const formatDateTime = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' +
                   date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        };

        // Helper para formatar moeda
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(amount);
        };

        const getPatientById = (id) => state.patients.find(p => p.id === id);


        // --- FIREBASE INITIALIZATION & AUTH ---

        const initializeFirebase = async () => {
            try {
                // CORREÇÃO: Usando a config fornecida diretamente
                app = initializeApp(firebaseConfig);
                
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);

                // Autenticação (Requer a ativação do método "Anônimo" no Console do Firebase)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        state.isAuthReady = true;
                        console.log("Usuário autenticado:", userId);
                        // Iniciar listeners após a autenticação
                        startDataListeners();
                        renderApp();
                    } else {
                        console.log("Nenhum usuário autenticado.");
                        state.isAuthReady = true;
                        renderApp();
                    }
                });
            } catch (error) {
                console.error("Erro ao inicializar Firebase ou Autenticar:", error);
                // Exibe o erro no loading
                const overlay = document.getElementById('loading-overlay');
                overlay.innerHTML = `<p class="text-red-700 font-semibold">ERRO FATAL: Falha na autenticação ou inicialização do Firebase.</p><p class="text-sm text-red-500">${error.message}</p>`;
            }
        };

        // --- FIREBASE DATA LISTENERS ---

        const privatePath = (collectionName) => `users/${userId}/${collectionName}`; // Caminho simplificado para o Firestore
        const startDataListeners = () => {
            if (!userId) return;

            // 1. Patients Listener
            onSnapshot(collection(db, privatePath('patients')), (snapshot) => {
                state.patients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Pacientes carregados:", state.patients.length);
                renderView();
            }, (error) => {
                console.error("Erro ao ouvir pacientes:", error);
            });

            // 2. Appointments Listener (Otimizado: apenas consultas futuras/hoje)
            const todayISO = new Date().toISOString().substring(0, 10);
            const qAppointments = query(
                collection(db, privatePath('appointments')),
                where('date', '>=', todayISO) // Filtro de otimização
            );
            onSnapshot(qAppointments, (snapshot) => {
                state.appointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Consultas carregadas:", state.appointments.length);
                renderView();
            }, (error) => {
                console.error("Erro ao ouvir consultas:", error);
            });

            // 3. Finances Listener
            onSnapshot(collection(db, privatePath('finances')), (snapshot) => {
                state.finances = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Registros financeiros carregados:", state.finances.length);
                renderView();
            }, (error) => {
                console.error("Erro ao ouvir finanças:", error);
            });
            // Note: Records and Documents will be fetched on demand (e.g., in PatientDetail)
        };

        // --- LINK GENERATION (REAL GOOGLE CALENDAR) ---
        
        // NOVO CÓDIGO: Gera a URL de Criação de Evento do Google Agenda pré-preenchida
        // O usuário clica neste link e, dentro do Google Agenda, gera o link do Meet final.
        const generateGoogleMeetLink = (patientName, date, time) => {
            // Retorna um link de atalho caso falhe em obter os dados
            if (!patientName || !date || !time) {
                return `https://calendar.google.com/calendar/r/eventedit?text=Nova+Consulta+Psicologia&details=Agendamento+rápido+PsychoPro.&sf=true`;
            }
            
            // Configura a duração do evento (1 hora)
            const startDate = new Date(date + 'T' + time + ':00');
            // Corrige se o fuso horário local for diferente do UTC, garantindo a data correta
            const endDate = new Date(startDate.getTime() + 60 * 60 * 1000); 
            
            const formatTime = (d) => {
                // Formato necessário: yyyyMMddTHHmmssZ (ISO 8601 básico em UTC)
                return d.toISOString().replace(/[:-]/g, '').substring(0, 15) + 'Z';
            }

            const start = formatTime(startDate);
            const end = formatTime(endDate);
            
            const title = encodeURIComponent(`Consulta Psicológica - ${patientName}`);
            const details = encodeURIComponent(`Consulta de ${patientName}. Clique em "Adicionar Conferência" ou "Add Google Meet" para gerar o link da reunião.`);
            
            // Link que preenche o Google Agenda
            return `https://calendar.google.com/calendar/r/eventedit?text=${title}&dates=${start}/${end}&details=${details}&sf=true`;
        };
        
        // --- CRUD OPERATIONS (COM LOADING) ---

        const savePatient = async (patientData, patientId = null) => {
            if (!userId) return;
            showLoading('Salvando paciente...');
            try {
                if (patientId) {
                    await updateDoc(doc(db, privatePath('patients'), patientId), patientData);
                    showMessage('Paciente atualizado com sucesso!', 'success');
                } else {
                    await addDoc(collection(db, privatePath('patients')), {
                        ...patientData,
                        createdAt: serverTimestamp(),
                        userId: userId
                    });
                    showMessage('Paciente cadastrado com sucesso!', 'success');
                }
            } catch (error) {
                console.error("Erro ao salvar paciente:", error);
                showMessage('Erro ao salvar paciente. Tente novamente.', 'error');
            } finally {
                hideLoading();
            }
        };

        const deletePatient = async (patientId) => {
            if (!userId) return;
            showLoading('Excluindo paciente...');
            try {
                await deleteDoc(doc(db, privatePath('patients'), patientId));
                showMessage('Paciente excluído com sucesso!', 'success');
                navigateTo('patients');
            } catch (error) {
                console.error("Erro ao excluir paciente:", error);
                showMessage('Erro ao excluir paciente. Tente novamente.', 'error');
            } finally {
                hideLoading();
            }
        };

        const saveAppointment = async (appointmentData, appointmentId = null) => {
            if (!userId) return;
            showLoading('Salvando consulta...');
            try {
                // 1. Obtém o nome do paciente
                const patientName = state.patients.find(p => p.id === appointmentData.patientId)?.fullName || 'Paciente Removido';
                
                // 2. Chama a nova função com os dados necessários (nome, data, hora)
                const meetLink = appointmentData.meetLink || generateGoogleMeetLink(
                    patientName, 
                    appointmentData.date, 
                    appointmentData.time
                );
                
                const dataToSave = {
                    ...appointmentData,
                    meetLink, // Agora contém o link do Google Agenda
                    patientName: patientName, // Usa o nome obtido acima
                    updatedAt: serverTimestamp(),
                    userId: userId
                };
                if (appointmentId) {
                    await updateDoc(doc(db, privatePath('appointments'), appointmentId), dataToSave);
                    showMessage('Consulta reagendada/atualizada com sucesso!', 'success');
                } else {
                    await addDoc(collection(db, privatePath('appointments')), {
                        ...dataToSave,
                        status: 'Scheduled',
                        createdAt: serverTimestamp(),
                    });
                    showMessage('Consulta agendada com sucesso! Link do Agenda gerado.', 'success');
                }
            } catch (error) {
                console.error("Erro ao salvar consulta:", error);
                showMessage('Erro ao salvar consulta. Tente novamente.', 'error');
            } finally {
                hideLoading();
            }
        };

        const deleteAppointment = async (appointmentId) => {
            if (!userId) return;
            showLoading('Cancelando consulta...');
            try {
                await deleteDoc(doc(db, privatePath('appointments'), appointmentId));
                showMessage('Consulta cancelada com sucesso.', 'success');
            } catch (error) {
                console.error("Erro ao excluir consulta:", error);
                showMessage('Erro ao excluir consulta. Tente novamente.', 'error');
            } finally {
                hideLoading();
            }
        };

        const saveFinanceRecord = async (recordData) => {
            if (!userId) return;
            showLoading('Registrando transação...');
            try {
                await addDoc(collection(db, privatePath('finances')), {
                    ...recordData,
                    amount: parseFloat(recordData.amount),
                    date: recordData.date || new Date().toISOString().substring(0, 10),
                    createdAt: serverTimestamp(),
                    userId: userId
                });
                showMessage('Registro financeiro salvo com sucesso!', 'success');
            } catch (error) {
                console.error("Erro ao salvar registro financeiro:", error);
                showMessage('Erro ao salvar registro financeiro. Tente novamente.', 'error');
            } finally {
                hideLoading();
            }
        };

        const deleteFinanceRecord = async (recordId) => {
            if (!userId) return;
            showLoading('Excluindo registro financeiro...');
            try {
                await deleteDoc(doc(db, privatePath('finances'), recordId));
                showMessage('Registro financeiro excluído.', 'success');
            } catch (error) {
                console.error("Erro ao excluir registro financeiro:", error);
                showMessage('Erro ao excluir registro financeiro. Tente novamente.', 'error');
            } finally {
                hideLoading();
            }
        };

        const uploadDocument = async (fileName, pdfContentBase64) => {
             if (!userId) return;
             showLoading('Fazendo upload do documento...');
             try {
                // Simulação de upload de PDF para o Firebase Storage
                const storageRefPath = `documents/${userId}/${fileName}_${Date.now()}.pdf`;
                const storageReference = storageRef(storage, storageRefPath);

                await uploadString(storageReference, pdfContentBase64, 'base64', {
                    contentType: 'application/pdf'
                });
                const downloadURL = await getDownloadURL(storageReference);
                console.log("PDF Uploaded, URL:", downloadURL);
                return downloadURL;
            } catch (error) {
                console.error("Erro ao fazer upload do documento:", error);
                showMessage('Erro ao gerar/salvar PDF. Verifique o console.', 'error');
                return null;
            } finally {
                hideLoading();
            }
        };
        
        const saveRecord = async (recordData, appointmentId, patientId) => {
            if (!userId) return;
            showLoading('Salvando registro de sessão...');
            try {
                await setDoc(doc(db, privatePath('records'), appointmentId), {
                    ...recordData,
                    patientId,
                    updatedAt: serverTimestamp(),
                    userId
                }, { merge: true });
                // Atualizar status da consulta para Completed (opcional, mas útil)
                await updateDoc(doc(db, privatePath('appointments'), appointmentId), { status: 'Completed' });

                showMessage('Registro de atendimento salvo e atualizado!', 'success');
            } catch (error) {
                console.error("Erro ao salvar registro de atendimento:", error);
                showMessage('Erro ao salvar registro. Tente novamente.', 'error');
            } finally {
                hideLoading();
            }
        };

        // --- LOGIC AND HELPERS ---

        const openWhatsAppChat = (number, message) => {
            const url = `https://wa.me/${number.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        };

        // --- UI/UX & RENDERING ---
        
        // Custom Loading Overlay for CRUD operations
        const showLoading = (message = 'Processando...') => {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.remove('hidden', 'opacity-0');
            overlay.classList.add('opacity-100');
            overlay.innerHTML = `
                <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-600"></div>
                <p class="mt-4 text-indigo-700 font-semibold">${message}</p>
            `;
        };

        const hideLoading = () => {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.remove('opacity-100');
            overlay.classList.add('opacity-0');
            // Wait for transition before hiding completely
            setTimeout(() => {
                overlay.classList.add('hidden');
                // Restore initial loading message for next app start/refresh
                overlay.innerHTML = `
                    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-600"></div>
                    <p class="mt-4 text-indigo-700 font-semibold">Carregando Plataforma...</p>
                    <p class="text-sm text-indigo-500">Autenticando com Firebase.</p>
                `;
            }, 300);
        };


        const navigateTo = (view, data = null) => {
            if (view === 'patientDetail' && data) {
                // data agora é o ID
                const patient = getPatientById(data);
                if (!patient) {
                    showMessage('Erro ao carregar paciente. ID inválido.', 'error');
                    return;
                }
                state.activePatient = patient;
                state.currentView = 'patientDetail';
            } else if (view === 'editPatient' && data) {
                state.activePatient = getPatientById(data);
                state.currentView = 'editPatient';
            } else {
                state.currentView = view;
                state.activePatient = null;
            }
            closeSidebar();
            renderView();
        };

        const toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
        };

        const closeSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.add('-translate-x-full');
            }
        };
        
        // Custom Message Box (replacing alert/confirm)
        const showMessage = (text, type = 'info', duration = 3000) => {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = text;
            msgBox.className = `p-3 rounded-lg shadow-xl text-white fixed bottom-20 left-1/2 transform -translate-x-1/2 transition-opacity duration-300 opacity-0 z-50`;
            if (type === 'success') msgBox.classList.add('bg-green-600');
            else if (type === 'error') msgBox.classList.add('bg-red-600');
            else msgBox.classList.add('bg-blue-600');
            setTimeout(() => {
                msgBox.classList.remove('opacity-0');
                msgBox.classList.add('opacity-100');
            }, 10);
            setTimeout(() => {
                msgBox.classList.remove('opacity-100');
                msgBox.classList.add('opacity-0');
            }, duration);
        };


        const renderView = () => {
            const content = document.getElementById('app-content');
            const view = state.currentView;
            let html = '';

            switch (view) {
                case 'dashboard':
                    html = renderDashboard();
                    break;
                case 'patients':
                    html = renderPatientList();
                    break;
                case 'patientDetail':
                    html = renderPatientDetail(state.activePatient);
                    break;
                case 'agenda':
                    html = renderAgenda();
                    break;
                case 'finance':
                    html = renderFinance();
                    break;
                case 'medications':
                    html = renderMedicationList(); // Simple list view
                    break;
                case 'addPatient':
                case 'editPatient':
                    html = renderPatientForm(view === 'editPatient' ? state.activePatient : null);
                    break;
                default:
                    html = `<div class="p-4 text-center text-gray-500">View ${view} not implemented.</div>`;
            }

            content.innerHTML = html;
            // Re-render Lucide icons
            lucide.createIcons();
            attachEventListeners();
        };

        const renderApp = () => {
            if (state.isAuthReady) {
                hideLoading(); // Esconde o loading inicial
                renderView();
            }
        };

        // --- EVENT HANDLERS (Non-intrusive JS) ---

        const handleNavigationClick = (e) => {
            e.preventDefault();
            const view = e.currentTarget.getAttribute('data-view');
            const data = e.currentTarget.getAttribute('data-data');
            navigateTo(view, data);
        };

        const handlePatientFormSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            
            // Validação de WhatsApp
            const whatsapp = form.whatsapp.value.replace(/\D/g, '');
            if (!whatsapp || whatsapp.length < 8) {
                showMessage('Número de WhatsApp inválido. Formato: (XX) XXXXX-XXXX', 'error');
                return;
            }

            // CORREÇÃO: Usar form.elements.id para evitar conflito de nome 'id' e resolver o TypeError
            const patientId = form.elements.id.value; 

            const patientData = {
                fullName: form.fullName.value,
                age: form.age.value ? parseInt(form.age.value) : null,
                contacts: {
                    whatsapp: form.whatsapp.value,
                    email: form.email.value,
                },
                address: form.address.value,
                clinicalHistory: form.clinicalHistory.value,
                medications: form.medications.value,
                observations: form.observations.value,
            };
            
            await savePatient(patientData, patientId || null);
            navigateTo('patients');
        };

        const attachEventListeners = () => {
            // 1. Navigation Listeners (Sidebar and Footer)
            document.querySelectorAll('[data-view]').forEach(element => {
                element.removeEventListener('click', handleNavigationClick); // Previne duplicidade
                element.addEventListener('click', handleNavigationClick);
            });

            // 2. Patient Form Submit
            document.getElementById('patient-form')?.addEventListener('submit', handlePatientFormSubmit);

            // 3. Appointment Form Submit (Existing logic, adding loading state)
            document.getElementById('appointment-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const appointmentData = {
                    patientId: form.patientId.value,
                    date: form.date.value,
                    time: form.time.value,
                    type: form.type.value,
                    notes: form.notes.value,
                    // meetLink será gerado na saveAppointment()
                };
                const appointmentId = form.getAttribute('data-app-id');
                await saveAppointment(appointmentData, appointmentId || null);
                closeModal();
                navigateTo('agenda');
            });

            // 4. Record Form Submit (Existing logic, adding loading state)
            document.getElementById('record-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const appointmentId = form.getAttribute('data-app-id');
                const patientId = form.getAttribute('data-patient-id');
                
                const recordData = {
                    queixaPrincipal: form.queixaPrincipal.value,
                    assuntosDiscutidos: form.assuntosDiscutidos.value,
                    tarefasSugestoes: form.tarefasSugestoes.value,
                };
                await saveRecord(recordData, appointmentId, patientId);
                closeModal();
            });

            // 5. Finance Form Submit (Existing logic, adding loading state)
            document.getElementById('finance-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const financeData = {
                    type: form.type.value,
                    description: form.description.value,
                    amount: form.amount.value,
                    date: form.date.value,
                };
                await saveFinanceRecord(financeData);
                closeModal();
                navigateTo('finance');
            });

            // 6. Document Form Submit (Simulation of PDF Generation and Storage)
            document.getElementById('document-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const patientId = form.getAttribute('data-patient-id');
                const patientName = form.getAttribute('data-patient-name');
                const docType = form.docType.value;
                const docContent = form.docContent.value;
                
                showMessage('Gerando PDF e fazendo upload...', 'info', 5000);
                // --- PDF Generation Simulation (A real application would use jsPDF or similar) ---
                const pdfContent = ` --- ${docType.toUpperCase().replace(/SIMPLES|ACOMPANHAMENTO/g, '').replace('ATTESTADO', 'ATESTADO')} ---
Paciente: ${patientName}
Conteúdo: ${docContent}
_________________________
Assinatura do Psicólogo(a)
Data: ${new Date().toLocaleDateString('pt-BR')} `;
                
                // Simple Base64 encoding of the text content for storage simulation
                const pdfBase64 = btoa(pdfContent);
                const downloadURL = await uploadDocument(`${docType}_${patientName}`, pdfBase64);

                if (downloadURL) {
                    // Salvar referência no Firestore (Documents Collection)
                    await addDoc(collection(db, privatePath('documents')), {
                        patientId,
                        patientName,
                        type: docType,
                        contentSummary: docContent.substring(0, 100) + '...',
                        fileUrl: downloadURL,
                        createdAt: serverTimestamp(),
                        userId: userId
                    });
                    showMessage('Documento gerado, salvo no Storage e referenciado no Firestore!', 'success');
                    closeModal();
                }
            });

            // 7. Confirmation Delete Button
            document.getElementById('confirm-delete-btn')?.addEventListener('click', async (e) => {
                const dataType = e.target.getAttribute('data-type');
                const id = e.target.getAttribute('data-id');
                if (dataType === 'patient') {
                    await deletePatient(id);
                } else if (dataType === 'appointment') {
                    await deleteAppointment(id);
                } else if (dataType === 'finance') {
                    await deleteFinanceRecord(id);
                }
                closeModal('confirmation-modal');
            });
        };

        // --- VIEW RENDER FUNCTIONS ---

        const renderDashboard = () => {
            const today = new Date().toISOString().substring(0, 10);
            const nextAppointments = state.appointments
                .filter(a => a.date >= today)
                .sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time))
                .slice(0, 5); // Próximas 5

            const totalPatients = state.patients.length;
            
            // CORREÇÃO LÓGICA: Calcular receita apenas do mês atual
            const currentMonth = new Date().toISOString().substring(0, 7);
            const monthlyIncome = state.finances
                .filter(f => f.type === 'income' && f.date && f.date.substring(0, 7) === currentMonth)
                .reduce((sum, f) => sum + f.amount, 0);

            return `
                <div class="p-4 space-y-6">
                    <h1 class="text-3xl font-bold text-gray-800">Olá, Psicólogo!</h1>
                    
                    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-100 grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-extrabold text-indigo-600">${totalPatients}</div>
                            <div class="text-xs text-gray-500 mt-1">Pacientes Ativos</div>
                        </div>
                        <div>
                            <div class="text-2xl font-extrabold text-green-600">${nextAppointments.filter(a => a.date === today).length}</div>
                            <div class="text-xs text-gray-500 mt-1">Atendimentos Hoje</div>
                        </div>
                        <div>
                            <div class="text-2xl font-extrabold text-blue-600">${formatCurrency(monthlyIncome)}</div>
                            <div class="text-xs text-gray-500 mt-1">Receita Mês (Atual)</div>
                        </div>
                    </div>

                    <h2 class="text-xl font-semibold text-gray-700">Acesso Rápido</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button data-view="addPatient" class="bg-indigo-500 text-white p-4 rounded-xl shadow-md hover:bg-indigo-600 transition flex items-center justify-center space-x-2">
                            <i data-lucide="user-plus" class="w-6 h-6"></i>
                            <span class="font-medium">Novo Paciente</span>
                        </button>
                        <button id="quick-schedule-btn" onclick="showAppointmentModal()" class="bg-green-500 text-white p-4 rounded-xl shadow-md hover:bg-green-600 transition flex items-center justify-center space-x-2">
                            <i data-lucide="calendar-plus" class="w-6 h-6"></i>
                            <span class="font-medium">Agendar Consulta</span>
                        </button>
                    </div>

                    <h2 class="text-xl font-semibold text-gray-700 pt-4">Próximos Atendimentos</h2>
                    <div class="space-y-3">
                        ${nextAppointments.length > 0 ?
                        nextAppointments.map(app => `
                            <div onclick="showAppointmentModal('${app.id}')" class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-indigo-500 flex justify-between items-center hover:shadow-md transition cursor-pointer">
                                <div>
                                    <div class="font-bold text-gray-800">${app.patientName}</div>
                                    <div class="text-sm text-gray-500">${new Date(app.date).toLocaleDateString('pt-BR', { weekday: 'short', day: 'numeric', month: 'short' })} às ${app.time}</div>
                                </div>
                                <div class="text-xs font-semibold px-2 py-1 rounded-full text-indigo-600 bg-indigo-100">${app.type}</div>
                            </div>
                        `).join('') : '<p class="text-center text-gray-500 bg-gray-50 p-4 rounded-lg">Nenhuma consulta agendada nos próximos dias.</p>'}
                    </div>
                </div>
            `;
        };
        
        const renderPatientList = () => {
            const patientCards = state.patients.map(p => `
                <div data-view="patientDetail" data-data="${p.id}" class="bg-white p-4 rounded-xl shadow-md flex items-center space-x-4 border-l-4 border-blue-500 hover:shadow-lg transition cursor-pointer">
                    <div class="w-12 h-12 flex items-center justify-center bg-blue-100 text-blue-600 rounded-full font-bold text-xl">${p.fullName.split(' ').map(n => n[0]).join('')}</div>
                    <div class="flex-grow">
                        <div class="font-semibold text-gray-800">${p.fullName}</div>
                        <div class="text-sm text-gray-500">Idade: ${p.age || 'N/A'} | ${p.contacts.whatsapp}</div>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                </div>
            `).join('');

            return `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-800">Pacientes (${state.patients.length})</h1>
                        <button data-view="addPatient" class="p-2 bg-indigo-500 text-white rounded-full shadow-md hover:bg-indigo-600 transition">
                            <i data-lucide="plus" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <div class="space-y-3">
                        ${patientCards || '<p class="text-center text-gray-500 bg-gray-50 p-4 rounded-lg">Nenhum paciente cadastrado.</p>'}
                    </div>
                </div>
            `;
        };

        const renderPatientForm = (patient = null) => {
            const isEdit = !!patient;
            return `
                <div class="p-4">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6">${isEdit ? 'Editar Paciente' : 'Novo Paciente'}</h1>
                    <form id="patient-form" class="space-y-4 bg-white p-6 rounded-xl shadow-lg">
                        <input type="hidden" name="id" value="${patient?.id || ''}">

                        <div class="space-y-2">
                            <label for="fullName" class="block text-sm font-medium text-gray-700">Nome Completo <span class="text-red-500">*</span></label>
                            <input type="text" id="fullName" name="fullName" value="${patient?.fullName || ''}" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label for="age" class="block text-sm font-medium text-gray-700">Idade</label>
                                <input type="number" id="age" name="age" value="${patient?.age || ''}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="space-y-2">
                                <label for="whatsapp" class="block text-sm font-medium text-gray-700">WhatsApp <span class="text-red-500">*</span></label>
                                <input type="tel" id="whatsapp" name="whatsapp" value="${patient?.contacts?.whatsapp || ''}" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="(XX) XXXXX-XXXX">
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label for="email" class="block text-sm font-medium text-gray-700">E-mail</label>
                            <input type="email" id="email" name="email" value="${patient?.contacts?.email || ''}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="space-y-2">
                            <label for="address" class="block text-sm font-medium text-gray-700">Endereço (Opcional)</label>
                            <input type="text" id="address" name="address" value="${patient?.address || ''}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>

                        <div class="space-y-2">
                            <label for="clinicalHistory" class="block text-sm font-medium text-gray-700">Histórico Clínico</label>
                            <textarea id="clinicalHistory" name="clinicalHistory" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">${patient?.clinicalHistory || ''}</textarea>
                        </div>
                        <div class="space-y-2">
                            <label for="medications" class="block text-sm font-medium text-gray-700">Medicações Utilizadas</label>
                            <textarea id="medications" name="medications" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">${patient?.medications || ''}</textarea>
                        </div>
                        <div class="space-y-2">
                            <label for="observations" class="block text-sm font-medium text-gray-700">Observações Importantes</label>
                            <textarea id="observations" name="observations" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">${patient?.observations || ''}</textarea>
                        </div>

                        <div class="flex space-x-4 pt-4">
                            <button type="button" data-view="patients" class="flex-1 p-3 bg-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-300 transition">Cancelar</button>
                            <button type="submit" class="flex-1 p-3 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700 transition">
                                ${isEdit ? 'Salvar Alterações' : 'Cadastrar Paciente'}
                            </button>
                        </div>
                    </form>
                </div>
            `;
        };

        const renderPatientDetail = (patient) => {
            if (!patient) return `<div class="p-4 text-center text-red-500">Paciente não encontrado.</div>`;
            // Filtrar Registros/Consultas do paciente
            const patientAppointments = state.appointments
                .filter(a => a.patientId === patient.id)
                .sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time)); // Mais recente primeiro

            return `
                <div class="p-4 space-y-6">
                    <div class="flex items-center space-x-4 mb-4">
                        <button data-view="patients" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition">
                            <i data-lucide="arrow-left" class="w-6 h-6 text-gray-600"></i>
                        </button>
                        <h1 class="text-2xl font-bold text-gray-800">${patient.fullName}</h1>
                    </div>

                    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-100 space-y-3">
                        <div class="text-sm text-gray-500 flex items-center"><i data-lucide="cake" class="w-4 h-4 mr-2"></i> Idade: <span class="font-medium text-gray-700 ml-1">${patient.age || 'N/A'}</span></div>
                        <div class="text-sm text-gray-500 flex items-center"><i data-lucide="mail" class="w-4 h-4 mr-2"></i> E-mail: <span class="font-medium text-gray-700 ml-1">${patient.contacts.email || 'N/A'}</span></div>
                        <div class="text-sm text-gray-500 flex items-center"><i data-lucide="phone" class="w-4 h-4 mr-2"></i> WhatsApp: <span class="font-medium text-gray-700 ml-1">${patient.contacts.whatsapp || 'N/A'}</span></div>
                    </div>

                    <div class="grid grid-cols-3 gap-3">
                        <button data-view="editPatient" data-data="${patient.id}" class="p-3 bg-blue-500 text-white rounded-xl text-xs font-semibold hover:bg-blue-600 transition flex flex-col items-center">
                            <i data-lucide="pencil" class="w-4 h-4 mb-1"></i> Editar
                        </button>
                        <button onclick="showAppointmentModal(null, '${patient.id}')" class="p-3 bg-green-500 text-white rounded-xl text-xs font-semibold hover:bg-green-600 transition flex flex-col items-center">
                            <i data-lucide="calendar-plus" class="w-4 h-4 mb-1"></i> Agendar
                        </button>
                        <button onclick="showDocumentModal('${patient.id}', '${patient.fullName}')" class="p-3 bg-orange-500 text-white rounded-xl text-xs font-semibold hover:bg-orange-600 transition flex flex-col items-center">
                            <i data-lucide="file-text" class="w-4 h-4 mb-1"></i> Documento
                        </button>
                    </div>

                    <div class="bg-white p-5 rounded-xl shadow-lg space-y-4">
                        <h3 class="text-lg font-semibold text-gray-700">Histórico Clínico</h3>
                        <p class="text-sm text-gray-600 whitespace-pre-wrap">${patient.clinicalHistory || 'N/A'}</p>
                        <h3 class="text-lg font-semibold text-gray-700 pt-3">Medicações e Obs.</h3>
                        <p class="text-sm text-gray-600 whitespace-pre-wrap">${patient.medications || 'N/A'}</p>
                        <p class="text-sm text-gray-600 whitespace-pre-wrap">${patient.observations || 'N/A'}</p>
                    </div>

                    <h2 class="text-xl font-semibold text-gray-700">Histórico de Atendimentos (${patientAppointments.length})</h2>
                    <div class="space-y-3">
                        ${patientAppointments.length > 0 ?
                        patientAppointments.map(app => `
                            <div onclick="showRecordModal('${app.id}', '${patient.id}')" class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-gray-400 flex justify-between items-center hover:shadow-md transition cursor-pointer">
                                <div>
                                    <div class="font-bold text-gray-800">Sessão de ${new Date(app.date).toLocaleDateString('pt-BR')}</div>
                                    <div class="text-sm text-gray-500">${app.type}</div>
                                    <a href="${app.meetLink}" target="_blank" class="text-xs text-indigo-500 hover:text-indigo-700 flex items-center mt-1"><i data-lucide="link" class="w-3 h-3 mr-1"></i> Link (Agenda)</a>
                                </div>
                                <div class="text-xs font-semibold px-2 py-1 rounded-full ${app.status === 'Completed' ? 'text-green-600 bg-green-100' : 'text-yellow-600 bg-yellow-100'}">${app.status === 'Completed' ? 'Concluída' : 'Agendada'}</div>
                            </div>
                        `).join('') : '<p class="text-center text-gray-500 bg-gray-50 p-4 rounded-lg">Nenhum atendimento registrado.</p>'}
                    </div>

                    <button onclick="showDeleteConfirmation('patient', '${patient.id}')" class="w-full p-3 bg-red-500 text-white rounded-xl font-semibold mt-4 hover:bg-red-600 transition">
                        Excluir Paciente Permanentemente
                    </button>
                </div>
            `;
        };

        const renderAgenda = () => {
            // Lógica para visualização semanal/mensal (simplesmente lista por enquanto)
            const sortedAppointments = state.appointments
                .sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time));
            
            const appointmentsGroupedByDate = sortedAppointments.reduce((acc, app) => {
                const dateKey = new Date(app.date).toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                if (!acc[dateKey]) {
                    acc[dateKey] = [];
                }
                acc[dateKey].push(app);
                return acc;
            }, {});

            const agendaHtml = Object.entries(appointmentsGroupedByDate).map(([date, apps]) => `
                <h3 class="text-lg font-semibold text-gray-700 mt-4 mb-2">${date}</h3>
                <div class="space-y-3">
                    ${apps.map(app => `
                        <div onclick="showAppointmentModal('${app.id}')" class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-indigo-500 flex justify-between items-center hover:shadow-md transition cursor-pointer">
                            <div>
                                <div class="font-bold text-gray-800">${app.time} - ${app.patientName}</div>
                                <div class="text-sm text-gray-500">${app.type}</div>
                                <a href="${app.meetLink}" target="_blank" class="text-xs text-indigo-500 hover:text-indigo-700 flex items-center mt-1"><i data-lucide="link" class="w-3 h-3 mr-1"></i> Link (Agenda)</a>
                            </div>
                            <div class="text-xs font-semibold px-2 py-1 rounded-full ${app.status === 'Completed' ? 'text-green-600 bg-green-100' : 'text-yellow-600 bg-yellow-100'}">${app.status === 'Completed' ? 'Concluída' : 'Agendada'}</div>
                        </div>
                    `).join('')}
                </div>
            `).join('');

            return `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-800">Agenda de Consultas</h1>
                        <button onclick="showAppointmentModal()" class="p-2 bg-indigo-500 text-white rounded-full shadow-md hover:bg-indigo-600 transition">
                            <i data-lucide="plus" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <div class="bg-indigo-50 p-3 rounded-lg flex justify-around text-sm font-medium mb-4">
                        <button class="text-indigo-600 font-bold border-b-2 border-indigo-600 pb-1">Próximos</button>
                        <button data-view="patients" class="text-gray-500 hover:text-indigo-600">Pacientes</button>
                    </div>

                    ${agendaHtml || '<p class="text-center text-gray-500 bg-gray-50 p-4 rounded-lg">Nenhuma consulta na agenda.</p>'}
                </div>
            `;
        };

        const renderFinance = () => {
            const currentMonth = new Date().toISOString().substring(0, 7);
            const monthlyRecords = state.finances.filter(f => f.date && f.date.substring(0, 7) === currentMonth);
            
            const totalIncome = monthlyRecords
                .filter(f => f.type === 'income')
                .reduce((sum, f) => sum + f.amount, 0);
            
            const totalExpense = monthlyRecords
                .filter(f => f.type === 'expense')
                .reduce((sum, f) => sum + f.amount, 0);
            
            const balance = totalIncome - totalExpense;

            const financeList = monthlyRecords
                .sort((a, b) => new Date(b.date) - new Date(a.date)) // Mais recente primeiro
                .map(f => `
                <div class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border-l-4 ${f.type === 'income' ? 'border-green-500' : 'border-red-500'}">
                    <div>
                        <div class="font-bold text-gray-800">${f.description}</div>
                        <div class="text-sm text-gray-500">${new Date(f.date).toLocaleDateString('pt-BR')}</div>
                    </div>
                    <div class="font-semibold ${f.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                        ${f.type === 'income' ? '+' : '-'} ${formatCurrency(f.amount)}
                        <button onclick="showDeleteConfirmation('finance', '${f.id}')" class="ml-2 text-gray-400 hover:text-red-500 transition">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            return `
                <div class="p-4 space-y-6">
                    <div class="flex justify-between items-center mb-4">
                        <h1 class="text-2xl font-bold text-gray-800">Gestão Financeira</h1>
                        <button onclick="showFinanceModal()" class="p-2 bg-indigo-500 text-white rounded-full shadow-md hover:bg-indigo-600 transition">
                            <i data-lucide="plus" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-100 grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-extrabold text-green-600">${formatCurrency(totalIncome)}</div>
                            <div class="text-xs text-gray-500 mt-1">Total Receita Mês</div>
                        </div>
                        <div>
                            <div class="text-2xl font-extrabold text-red-600">${formatCurrency(totalExpense)}</div>
                            <div class="text-xs text-gray-500 mt-1">Total Despesa Mês</div>
                        </div>
                        <div>
                            <div class="text-2xl font-extrabold ${balance >= 0 ? 'text-blue-600' : 'text-red-600'}">${formatCurrency(balance)}</div>
                            <div class="text-xs text-gray-500 mt-1">Saldo Mês</div>
                        </div>
                    </div>

                    <h2 class="text-xl font-semibold text-gray-700 pt-3">Registros de ${new Date().toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}</h2>
                    <div class="space-y-3">
                        ${financeList || '<p class="text-center text-gray-500 bg-gray-50 p-4 rounded-lg">Nenhum registro financeiro neste mês.</p>'}
                    </div>
                </div>
            `;
        };

        const renderMedicationList = () => {
            // Placeholder para a lista de medicações (não implementada na lógica de dados)
            return `
                <div class="p-4">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6">Lista de Documentos</h1>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <p class="text-gray-500">Esta seção listaria todos os documentos gerados e salvos no Storage (requer uma nova renderização de coleção).</p>
                        <p class="text-sm text-gray-400 mt-2">Atualmente, você pode gerá-los na tela de detalhes do paciente.</p>
                    </div>
                </div>
            `;
        };

        // --- MODAL FUNCTIONS (KEPT INLINE FOR SIMPLICITY) ---

        // Helper para mostrar o modal
        const showModal = (content, title = 'Detalhes', id = 'general-modal') => {
            const modal = document.getElementById(id);
            const modalContent = id === 'general-modal' ? document.getElementById('general-modal-content') : document.getElementById('confirmation-modal-content');
            const modalTitle = id === 'general-modal' ? document.getElementById('general-modal-title') : document.getElementById('confirmation-modal-title');
            
            if (modalTitle) modalTitle.textContent = title;
            if (modalContent) modalContent.innerHTML = content;
            
            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('opacity-100');
            // Re-run event listeners for any new content inside the modal
            lucide.createIcons();
            attachEventListeners(); 
        };

        const closeModal = (id = 'general-modal') => {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.remove('opacity-100');
                modal.classList.add('opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        };

        // Modal: Appointment (Agendar/Editar Consulta)
        window.showAppointmentModal = (appointmentId = null, patientId = null) => {
            const app = appointmentId ? state.appointments.find(a => a.id === appointmentId) : null;
            const title = app ? 'Editar/Reagendar Consulta' : 'Nova Consulta';
            
            const defaultDate = app ? app.date : new Date().toISOString().substring(0, 10);
            const defaultTime = app ? app.time : '09:00';
            const defaultType = app ? app.type : 'Online';

            const patientOptions = state.patients.map(p => 
                `<option value="${p.id}" ${p.id === (app?.patientId || patientId) ? 'selected' : ''}>${p.fullName}</option>`
            ).join('');

            const content = `
                <form id="appointment-form" data-app-id="${appointmentId || ''}" class="space-y-4">
                    <div class="space-y-2">
                        <label for="app-patientId" class="block text-sm font-medium text-gray-700">Paciente <span class="text-red-500">*</span></label>
                        <select id="app-patientId" name="patientId" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Selecione um Paciente</option>
                            ${patientOptions}
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label for="app-date" class="block text-sm font-medium text-gray-700">Data <span class="text-red-500">*</span></label>
                            <input type="date" id="app-date" name="date" value="${defaultDate}" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="space-y-2">
                            <label for="app-time" class="block text-sm font-medium text-gray-700">Hora <span class="text-red-500">*</span></label>
                            <input type="time" id="app-time" name="time" value="${defaultTime}" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label for="app-type" class="block text-sm font-medium text-gray-700">Tipo de Consulta <span class="text-red-500">*</span></label>
                        <select id="app-type" name="type" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="Online" ${defaultType === 'Online' ? 'selected' : ''}>Online</option>
                            <option value="Presencial" ${defaultType === 'Presencial' ? 'selected' : ''}>Presencial</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label for="app-notes" class="block text-sm font-medium text-gray-700">Notas</label>
                        <textarea id="app-notes" name="notes" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">${app?.notes || ''}</textarea>
                    </div>
                    ${app?.meetLink ? `
                        <p class="text-xs text-gray-500">Link do Google Agenda: <a href="${app.meetLink}" target="_blank" class="text-indigo-500 hover:text-indigo-700 font-semibold">Clique para Gerar Link do Meet</a></p>
                    ` : ''}
                    <button type="submit" class="w-full p-3 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700 transition">
                        ${app ? 'Salvar Alterações/Reagendar' : 'Agendar Consulta'}
                    </button>
                    ${app ? `
                        <button type="button" onclick="showDeleteConfirmation('appointment', '${app.id}')" class="w-full p-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600 transition mt-2">
                            Cancelar Consulta
                        </button>
                    ` : ''}
                </form>
            `;
            showModal(content, title);
        };

        // Modal: Record (Registro de Atendimento/Evolução)
        window.showRecordModal = async (appointmentId, patientId) => {
            const patient = getPatientById(patientId);
            if (!patient) return showMessage('Paciente não encontrado.', 'error');

            showLoading('Buscando registro...');
            const recordRef = doc(db, privatePath('records'), appointmentId);
            const recordSnap = await getDoc(recordRef);
            const record = recordSnap.exists() ? recordSnap.data() : null;
            hideLoading();

            const title = `Registro - ${patient.fullName} (${formatDateTime(new Date())})`;
            const content = `
                <form id="record-form" data-app-id="${appointmentId}" data-patient-id="${patientId}" class="space-y-4">
                    <div class="space-y-2">
                        <label for="record-queixa" class="block text-sm font-medium text-gray-700">Queixa Principal</label>
                        <textarea id="record-queixa" name="queixaPrincipal" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>${record?.queixaPrincipal || ''}</textarea>
                    </div>
                    <div class="space-y-2">
                        <label for="record-assuntos" class="block text-sm font-medium text-gray-700">Assuntos Discutidos / Evolução</label>
                        <textarea id="record-assuntos" name="assuntosDiscutidos" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>${record?.assuntosDiscutidos || ''}</textarea>
                    </div>
                    <div class="space-y-2">
                        <label for="record-tarefas" class="block text-sm font-medium text-gray-700">Tarefas/Sugestões Próxima Sessão</label>
                        <textarea id="record-tarefas" name="tarefasSugestoes" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">${record?.tarefasSugestoes || ''}</textarea>
                    </div>
                    <button type="submit" class="w-full p-3 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700 transition">
                        Salvar Registro de Atendimento
                    </button>
                    ${record ? `<p class="text-xs text-center text-gray-500 mt-2">Última atualização: ${formatDateTime(record.updatedAt || record.createdAt)}</p>` : ''}
                </form>
            `;
            showModal(content, title);
        };

        // Modal: Finance (Registro de Transação)
        window.showFinanceModal = (recordId = null) => {
            const record = recordId ? state.finances.find(f => f.id === recordId) : null;
            const title = record ? 'Editar Transação' : 'Nova Transação Financeira';
            const isEdit = !!record;
            
            const content = `
                <form id="finance-form" data-record-id="${recordId || ''}" class="space-y-4">
                    <div class="space-y-2">
                        <label for="finance-type" class="block text-sm font-medium text-gray-700">Tipo <span class="text-red-500">*</span></label>
                        <select id="finance-type" name="type" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="income" ${record?.type === 'income' ? 'selected' : ''}>Receita (Entrada)</option>
                            <option value="expense" ${record?.type === 'expense' ? 'selected' : ''}>Despesa (Saída)</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label for="finance-description" class="block text-sm font-medium text-gray-700">Descrição <span class="text-red-500">*</span></label>
                        <input type="text" id="finance-description" name="description" value="${record?.description || ''}" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label for="finance-amount" class="block text-sm font-medium text-gray-700">Valor (R$) <span class="text-red-500">*</span></label>
                            <input type="number" id="finance-amount" name="amount" step="0.01" value="${record?.amount || ''}" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="space-y-2">
                            <label for="finance-date" class="block text-sm font-medium text-gray-700">Data <span class="text-red-500">*</span></label>
                            <input type="date" id="finance-date" name="date" value="${record?.date || new Date().toISOString().substring(0, 10)}" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    <button type="submit" class="w-full p-3 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700 transition">
                        ${isEdit ? 'Salvar Alterações' : 'Registrar Transação'}
                    </button>
                </form>
            `;
            showModal(content, title);
        };

        // Modal: Document (Emissão de Documentos)
        window.showDocumentModal = (patientId, patientName) => {
            const title = `Emissão de Documento para ${patientName}`;
            const today = new Date().toLocaleDateString('pt-BR');
            const content = `
                <form id="document-form" data-patient-id="${patientId}" data-patient-name="${patientName}" class="space-y-4">
                    <div class="space-y-2">
                        <label for="doc-type" class="block text-sm font-medium text-gray-700">Tipo de Documento <span class="text-red-500">*</span></label>
                        <select id="doc-type" name="docType" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Selecione...</option>
                            <option value="AtestadoInaptidao">Atestado de Inaptidão</option>
                            <option value="DeclaracaoAcompanhamento">Declaração de Acompanhamento</option>
                            <option value="ReceitaSimples">Receita Simples</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label for="doc-content" class="block text-sm font-medium text-gray-700">Conteúdo do Documento (Edite aqui)</label>
                        <textarea id="doc-content" name="docContent" rows="10" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 doc-editor-area">
                            Prezado(a), escreva o conteúdo do documento aqui.
                        </textarea>
                    </div>
                    <button type="submit" class="w-full p-3 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700 transition">
                        Gerar e Salvar Documento (PDF)
                    </button>
                    <button type="button" onclick="simulatedWhatsAppSend('${patientName}')" class="w-full p-3 bg-green-500 text-white rounded-xl font-semibold hover:bg-green-600 transition mt-2">
                        <i data-lucide="whatsapp" class="w-5 h-5 mr-2 inline-block"></i> Enviar por WhatsApp (Simulado)
                    </button>
                </form>
            `;
            showModal(content, title);
            
            // Populate content based on type selection (helper logic)
            document.getElementById('doc-type').addEventListener('change', (e) => {
                const type = e.target.value;
                const textarea = document.getElementById('doc-content');
                let newContent = `Prezado(a), edite o conteúdo do documento ${type} aqui.`;

                if (type === 'ReceitaSimples') {
                    newContent = `RECEITA SIMPLES\n\n- Medicamento: [Nome do Remédio] - Dosagem: [X mg]\n- Frequência: [X vezes ao dia]\n\nObservações: [Informações Adicionais]`;
                } else if (type === 'AtestadoInaptidao') {
                    newContent = `Eu, [Seu Nome], Psicólogo(a) registrado(a) no CRP, atesto a inaptidão momentânea de ${patientName} para [atividade/trabalho] por um período de [X dias], a partir desta data, ${today}.`;
                } else if (type === 'DeclaracaoAcompanhamento') {
                    newContent = `Eu, [Seu Nome], Psicólogo(a) registrado(a) no CRP, declaro que ${patientName} está em acompanhamento psicológico sob meus cuidados desde [Data de Início].`;
                }
                textarea.value = newContent;
            });
        };

        window.simulatedWhatsAppSend = (patientName) => {
            const patient = state.patients.find(p => p.fullName === patientName);
            if (patient) {
                openWhatsAppChat(patient.contacts.whatsapp, `Olá ${patientName}, aqui está o seu documento que acabamos de gerar. https://es.dopdf.com/`);
            } else {
                showMessage('Paciente não encontrado para enviar WhatsApp.', 'error');
            }
        };

        // Modal: Confirmation
        window.showDeleteConfirmation = (dataType, id) => {
            const title = `Confirmar Exclusão`;
            const message = `Você tem certeza que deseja excluir este ${dataType} permanentemente? Esta ação é irreversível.`;
            const content = `
                <p class="text-center text-gray-700 mb-6">${message}</p>
                <div class="flex space-x-4">
                    <button onclick="closeModal('confirmation-modal')" class="flex-1 p-3 bg-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-300 transition">Cancelar</button>
                    <button id="confirm-delete-btn" data-type="${dataType}" data-id="${id}" class="flex-1 p-3 bg-red-600 text-white rounded-xl font-semibold hover:bg-red-700 transition">Confirmar Exclusão</button>
                </div>
            `;
            showModal(content, title, 'confirmation-modal');
        };

        // --- MAIN APP INIT ---
        window.onload = () => {
            initializeFirebase();

            // Expor funções para uso no HTML inline (para Modals e outros elementos não refatorados)
            window.navigateTo = navigateTo;
            window.toggleSidebar = toggleSidebar;
            window.closeSidebar = closeSidebar;
            window.closeModal = closeModal;
            window.showAppointmentModal = showAppointmentModal;
            window.showRecordModal = showRecordModal;
            window.showFinanceModal = showFinanceModal;
            window.showDocumentModal = showDocumentModal;
            window.showDeleteConfirmation = showDeleteConfirmation;
        };
    </script>
    <style>
        /* Custom styles */
        .doc-editor-area {
            min-height: 200px; 
            font-family: monospace; 
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="min-h-screen">
    
    <div id="loading-overlay" class="fixed inset-0 bg-indigo-50/80 backdrop-blur-sm flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-600"></div>
        <p class="mt-4 text-indigo-700 font-semibold">Carregando Plataforma...</p>
        <p class="text-sm text-indigo-500">Autenticando com Firebase.</p>
    </div>

    <div id="message-box" class="opacity-0 transition-opacity duration-300 fixed bottom-20 left-1/2 transform -translate-x-1/2 z-50"></div>

    <div class="relative flex h-screen overflow-hidden">
        
        <div id="sidebar" class="fixed inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out bg-white w-64 p-4 shadow-xl z-30 flex flex-col">
            <div class="flex-shrink-0 mb-8">
                <h2 class="text-2xl font-extrabold text-indigo-600 flex items-center">
                    <i data-lucide="brain-circuit" class="w-7 h-7 mr-2"></i> PsychoPro
                </h2>
            </div>
            <nav class="flex-grow space-y-2">
                <button data-view="dashboard" class="w-full flex items-center p-3 rounded-xl text-gray-700 hover:bg-indigo-50 transition font-medium">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard
                </button>
                <button data-view="patients" class="w-full flex items-center p-3 rounded-xl text-gray-700 hover:bg-indigo-50 transition font-medium">
                    <i data-lucide="users" class="w-5 h-5 mr-3"></i> Pacientes
                </button>
                <button data-view="agenda" class="w-full flex items-center p-3 rounded-xl text-gray-700 hover:bg-indigo-50 transition font-medium">
                    <i data-lucide="calendar" class="w-5 h-5 mr-3"></i> Agenda
                </button>
                <button data-view="finance" class="w-full flex items-center p-3 rounded-xl text-gray-700 hover:bg-indigo-50 transition font-medium">
                    <i data-lucide="wallet" class="w-5 h-5 mr-3"></i> Financeiro
                </button>
                <button data-view="medications" class="w-full flex items-center p-3 rounded-xl text-gray-700 hover:bg-indigo-50 transition font-medium">
                    <i data-lucide="pill" class="w-5 h-5 mr-3"></i> Documentos/Docs
                </button>
            </nav>
            <div class="flex-shrink-0 pt-4 border-t border-gray-100">
                <button onclick="auth.signOut();" class="w-full flex items-center p-3 rounded-xl text-gray-700 hover:bg-red-50 hover:text-red-600 transition font-medium">
                    <i data-lucide="log-out" class="w-5 h-5 mr-3"></i> Sair
                </button>
            </div>
        </div>

        <div class="flex-1 flex flex-col overflow-y-auto lg:ml-64 bg-gray-50">
            <header class="sticky top-0 bg-white shadow-md p-4 flex items-center justify-between z-20">
                <button onclick="toggleSidebar()" class="lg:hidden p-2 text-gray-600 hover:bg-gray-100 rounded-full">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <h1 class="text-xl font-bold text-gray-800">PsychoPro</h1>
                <div class="flex items-center space-x-3">
                    <button class="p-2 text-gray-600 hover:bg-gray-100 rounded-full">
                        <i data-lucide="bell" class="w-6 h-6"></i>
                    </button>
                    <div class="w-8 h-8 bg-indigo-500 text-white rounded-full flex items-center justify-center font-bold text-sm">P</div>
                </div>
            </header>

            <main id="app-content" class="flex-1 pb-20"></main>

            <nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t shadow-2xl p-2 z-30">
                <div class="flex justify-around">
                    <button data-view="dashboard" class="text-indigo-600 flex flex-col items-center p-2">
                        <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
                        <span class="text-xs">Início</span>
                    </button>
                    <button data-view="patients" class="text-gray-500 hover:text-indigo-600 flex flex-col items-center p-2">
                        <i data-lucide="users" class="w-6 h-6"></i>
                        <span class="text-xs">Pacientes</span>
                    </button>
                    <button onclick="showAppointmentModal()" class="p-3 bg-indigo-500 text-white rounded-full shadow-lg -mt-4 transform transition-transform hover:scale-105">
                        <i data-lucide="calendar-plus" class="w-7 h-7"></i>
                    </button>
                    <button data-view="agenda" class="text-gray-500 hover:text-indigo-600 flex flex-col items-center p-2">
                        <i data-lucide="calendar" class="w-6 h-6"></i>
                        <span class="text-xs">Agenda</span>
                    </button>
                    <button data-view="finance" class="text-gray-500 hover:text-indigo-600 flex flex-col items-center p-2">
                        <i data-lucide="wallet" class="w-6 h-6"></i>
                        <span class="text-xs">Financeiro</span>
                    </button>
                </div>
            </nav>
        </div>
    </div>

    <div id="general-modal" onclick="if(event.target.id === 'general-modal') closeModal()" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-lg sm:rounded-xl shadow-2xl w-full sm:max-w-lg max-h-[90vh] overflow-y-auto transform transition-all duration-300 translate-y-0 sm:translate-y-0">
            <div class="flex justify-between items-center p-5 border-b sticky top-0 bg-white z-10">
                <h3 id="general-modal-title" class="text-xl font-bold text-gray-800">Modal Title</h3>
                <button onclick="closeModal()" class="p-2 text-gray-500 hover:bg-gray-100 rounded-full">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="general-modal-content" class="p-6">
                </div>
        </div>
    </div>

    <div id="confirmation-modal" onclick="if(event.target.id === 'confirmation-modal') closeModal('confirmation-modal')" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all duration-300">
            <h3 id="confirmation-modal-title" class="text-xl font-bold text-red-600 mb-4">Confirmar Ação</h3>
            <div id="confirmation-modal-content">
                 </div>
        </div>
    </div>

</body>
</html>
