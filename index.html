<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Controle Financeiro</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Importar Chart.js para os gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    
    <style>
        :root {
            /* Vari√°veis do Tema Claro */
            --color-primary-blue: #4f46e5;
            --color-success-green: #10b981;
            --color-danger-red: #ef4444;
            --color-secondary-purple: #a855f7;
            --color-background: #f3f4f6;
            --color-surface: #ffffff;
            --color-text-dark: #1f2937;
            --color-text-light: #4b5563;
            --border-radius-card: 12px;
            --shadow-light: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        /* Tema Escuro */
        .dark-mode {
            --color-background: #111827;
            --color-surface: #1f2937;
            --color-text-dark: #f9fafb;
            --color-text-light: #d1d5db;
            --shadow-light: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        body {
            background-color: var(--color-background);
            color: var(--color-text-dark);
            min-height: 100vh;
        }

        #app-header {
            background-color: var(--color-surface);
            padding: 16px 20px;
            box-shadow: var(--shadow-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #theme-toggle {
            background: none;
            border: 1px solid var(--color-text-light);
            color: var(--color-text-dark);
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            transition: all 0.3s;
        }
        
        #theme-toggle:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        .dark-mode #theme-toggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        #app-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Estilo para Cards */
        .card {
            background-color: var(--color-surface);
            color: var(--color-text-dark);
            border-radius: var(--border-radius-card);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-light);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .dark-mode .card:hover {
             box-shadow: 0 10px 15px -3px rgba(255, 255, 255, 0.05), 0 4px 6px -4px rgba(255, 255, 255, 0.05);
        }

        /* Estilo para Bot√µes */
        button {
            background-color: var(--color-primary-blue);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s;
        }

        button:hover:not(:disabled) {
            background-color: #3730a3;
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-success { background-color: var(--color-success-green); }
        .btn-success:hover { background-color: #059669; }
        .btn-danger { background-color: var(--color-danger-red); }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-secondary { background-color: var(--color-text-light); }
        .btn-secondary:hover { background-color: #6b7280; }

        /* Estilo para Inputs e Forms */
        input:not([type="radio"]),
        select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--color-text-light);
            background-color: var(--color-surface);
            color: var(--color-text-dark);
            border-radius: 6px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus {
            border-color: var(--color-primary-blue);
            outline: none;
        }

        .error-message {
            color: var(--color-danger-red);
            margin-top: 10px;
        }

        /* --- Estilos Espec√≠ficos do App --- */

        /* Layout do Dashboard */
        #summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        #dashboard-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr;
        }

        @media (min-width: 1024px) {
            #dashboard-grid {
                grid-template-columns: 2fr 1fr; /* Gr√°ficos mais largos */
            }
        }
        
        /* Layout de Tabelas */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
            border-radius: var(--border-radius-card);
            overflow: hidden;
        }
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .dark-mode .data-table th, .dark-table .data-table td {
            border-bottom: 1px solid #374151;
        }
        .data-table th {
            background-color: var(--color-background);
            color: var(--color-text-light);
            font-weight: 600;
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }
        .data-table tr:hover {
            background-color: rgba(79, 70, 229, 0.05); /* Leve destaque */
        }
        .dark-mode .data-table tr:hover {
            background-color: rgba(79, 70, 229, 0.1);
        }
        .data-table td button {
            padding: 5px 10px;
            margin-right: 5px;
            font-size: 0.8rem;
        }

        /* Estilos de Status e Tipo */
        .status-pago { color: var(--color-success-green); font-weight: bold; }
        .status-pendente { color: var(--color-danger-red); font-weight: bold; }
        .tipo-entrada { color: var(--color-success-green); }
        .tipo-saida { color: var(--color-danger-red); }

        /* --- Anima√ß√£o de Pulso (Feedback Visual) --- */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 var(--color-success-green); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 var(--color-danger-red); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        #new-account-form {
            position: relative;
            /* Garante que o box-shadow do pulso n√£o seja cortado */
        }

        .pulse-green {
            animation: pulse-green 0.5s ease-out;
        }

        .pulse-red {
            animation: pulse-red 0.5s ease-out;
        }
        
        /* Toast Notification */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            background-color: var(--color-surface);
            color: var(--color-text-dark);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-light);
            margin-bottom: 10px;
            min-width: 250px;
            border-left: 5px solid;
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s, transform 0.3s;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { border-color: var(--color-success-green); }
        .toast.error { border-color: var(--color-danger-red); }
        .toast.info { border-color: var(--color-primary-blue); }
        
        /* Estilo para a lista de Vencimentos */
        #upcoming-accounts-list {
            list-style: none;
            padding: 0;
        }
        .upcoming-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .dark-mode .upcoming-item {
            border-bottom: 1px solid #374151;
        }
        .upcoming-item:last-child { border-bottom: none; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <header id="app-header">
        <h1>Meu Controle Financeiro üí∞</h1>
        <div style="display: flex; gap: 10px;">
            <button id="theme-toggle" title="Alternar Tema">
                <span class="material-icons">dark_mode</span>
            </button>
            <button id="logout-btn" style="display:none;">Sair</button>
        </div>
    </header>

    <main id="app-container">
        <!-- √Årea de Login/Cadastro -->
        <section id="login-area">
            <h2>üîê Login ou Cadastro</h2>
            <form id="login-form" class="card">
                <input type="email" id="login-email" placeholder="E-mail" required>
                <input type="password" id="login-password" placeholder="Senha (m√≠n. 6 caracteres)" required>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" style="flex: 1;">Entrar</button>
                    <button type="button" id="signup-btn" class="btn-secondary" style="flex: 1;">Criar Conta</button>
                </div>
                <p id="auth-error" class="error-message"></p>
            </form>
        </section>

        <!-- √Årea do Dashboard -->
        <section id="dashboard-area" style="display:none;">
            <div id="navigation-menu" style="margin-bottom: 20px;">
                <button id="nav-dashboard" class="btn-secondary">Dashboard</button>
                <button id="nav-categories" class="btn-secondary">Gerenciar Categorias</button>
            </div>
            
            <!-- Vis√£o: Dashboard Principal -->
            <div id="view-dashboard">
                <h2>üìä Dashboard</h2>
                <div id="summary-cards">
                    <!-- Cards de resumo (Saldo, Entradas, Sa√≠das) ser√£o injetados aqui -->
                </div>

                <div id="dashboard-grid">
                    <!-- Gr√°ficos -->
                    <div class="card">
                        <h3>Evolu√ß√£o Mensal (Entradas vs. Sa√≠das)</h3>
                        <canvas id="balanceChart" width="100%" height="50"></canvas>
                    </div>

                    <!-- Pr√≥ximos Vencimentos -->
                    <div class="card">
                        <h3>üóìÔ∏è Pr√≥ximos Vencimentos</h3>
                        <div id="upcoming-filters" style="display: flex; gap: 5px; margin-bottom: 15px;">
                            <button class="btn-secondary" data-days="7">7 dias</button>
                            <button class="btn-secondary" data-days="15">15 dias</button>
                            <button class="btn-secondary" data-days="30">30 dias</button>
                        </div>
                        <ul id="upcoming-accounts-list">
                            <li style="color: var(--color-text-light);">Selecione um filtro ou cadastre contas.</li>
                        </ul>
                    </div>
                </div>

                <!-- Formul√°rio de Nova Conta -->
                <div class="card">
                    <h3>+ Cadastrar Novo Lan√ßamento</h3>
                    <form id="new-account-form">
                        <div id="type-selector" style="margin-bottom: 15px;">
                            <label style="font-weight: bold; margin-right: 15px;">Tipo:</label>
                            <label><input type="radio" name="account-type" value="entrada" checked> Entrada (Receber)</label>
                            <label><input type="radio" name="account-type" value="saida"> Sa√≠da (Pagar)</label>
                        </div>
                        
                        <input type="text" id="account-name" placeholder="Nome do Lan√ßamento (Ex: Sal√°rio, Aluguel)" required>
                        <select id="account-category" required><option value="">Selecione a Categoria</option></select>
                        <input type="text" id="account-value" placeholder="Valor (R$)" required>
                        <input type="date" id="account-due-date" required>
                        
                        <input type="hidden" id="account-doc-id"> <!-- Para uso em edi√ß√£o -->
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button type="submit" id="save-account-btn" style="flex: 1;">Salvar Lan√ßamento</button>
                            <button type="button" id="cancel-edit-btn" class="btn-danger" style="display: none;">Cancelar Edi√ß√£o</button>
                        </div>
                    </form>
                </div>

                <!-- Lista de Lan√ßamentos (Para Edi√ß√£o/Exclus√£o) -->
                <div class="card">
                    <h3>üìã Hist√≥rico de Lan√ßamentos (Todas as Contas)</h3>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Valor</th>
                                    <th>Tipo</th>
                                    <th>Status</th>
                                    <th>Vencimento</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="accounts-table-body">
                                <tr><td colspan="6" style="text-align: center; color: var(--color-text-light);">Carregando lan√ßamentos...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Vis√£o: Gerenciar Categorias -->
            <div id="view-categories" style="display: none;">
                <h2>‚öôÔ∏è Gerenciar Categorias</h2>

                <!-- Formul√°rio de Categoria -->
                <div class="card" style="max-width: 400px;">
                    <h3>+ Nova Categoria</h3>
                    <form id="new-category-form">
                        <input type="text" id="category-name" placeholder="Nome da Categoria (Ex: Alimenta√ß√£o, Renda Fixa)" required>
                        <input type="hidden" id="category-doc-id"> <!-- Para Edi√ß√£o -->
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" id="save-category-btn" style="flex: 1;">Salvar Categoria</button>
                            <button type="button" id="cancel-category-btn" class="btn-danger" style="display: none;">Cancelar Edi√ß√£o</button>
                        </div>
                    </form>
                </div>

                <!-- Lista de Categorias -->
                <div class="card">
                    <h3>Lista de Categorias</h3>
                    <table class="data-table" style="max-width: 600px;">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="categories-table-body">
                            <tr><td colspan="2" style="text-align: center; color: var(--color-text-light);">Carregando categorias...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <script type="module">
        // --- 0. CONFIGURA√á√ÉO FIREBASE E IMPORTS ---

        // Importar as fun√ß√µes necess√°rias do SDK do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        // CORRE√á√ÉO: Certificando-se de importar todas as fun√ß√µes de autentica√ß√£o necess√°rias
        import { onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // Vari√°veis globais (dispon√≠veis no ambiente Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicializar o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let currentUserId = null;
        let allAccountsData = []; // Armazena todos os lan√ßamentos para uso em gr√°ficos/listas
        let accountsUnsubscribe = null; // Listener de contas
        let categoriesUnsubscribe = null; // Listener de categorias
        let myChart = null; // Inst√¢ncia do Chart.js
        // Inicializa√ß√£o de cole√ß√µes (ser√£o ajustadas em `updateUI`)
        let COLLECTION_ACCOUNTS = `artifacts/${appId}/users/default-user/contas`;
        let COLLECTION_CATEGORIES = `artifacts/${appId}/users/default-user/categorias`;


        // --- 1. ELEMENTOS DO DOM ---
        const loginArea = document.getElementById('login-area');
        const dashboardArea = document.getElementById('dashboard-area');
        const logoutBtn = document.getElementById('logout-btn');
        const signupBtn = document.getElementById('signup-btn');
        const authError = document.getElementById('auth-error');
        const loginForm = document.getElementById('login-form');
        const newAccountForm = document.getElementById('new-account-form');
        const newCategoryForm = document.getElementById('new-category-form');
        const typeSelector = document.getElementById('type-selector');
        const accountValueInput = document.getElementById('account-value');
        const balanceChartCanvas = document.getElementById('balanceChart');
        const upcomingFilters = document.getElementById('upcoming-filters');
        const upcomingAccountsList = document.getElementById('upcoming-accounts-list');
        const accountsTableBody = document.getElementById('accounts-table-body');
        const categoriesTableBody = document.getElementById('categories-table-body');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const navDashboard = document.getElementById('nav-dashboard');
        const navCategories = document.getElementById('nav-categories');
        const viewDashboard = document.getElementById('view-dashboard');
        const viewCategories = document.getElementById('view-categories');

        // --- 2. HELPERS E UTILS ---

        /** Fun√ß√£o para exibir notifica√ß√µes Toast */
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            // For√ßa o reflow para aplicar a transi√ß√£o
            void toast.offsetWidth; 
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, { once: true });
            }, 3000);
        }

        /** Formata um n√∫mero para o formato de moeda brasileira (R$ X.XXX,XX) */
        function formatCurrency(value) {
            if (typeof value !== 'number') return 'R$ 0,00';
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        /** Converte string formatada (R$ 1.000,00) para n√∫mero (1000.00) */
        function parseCurrency(str) {
            if (!str) return 0;
            // Remove R$, pontos e substitui v√≠rgula por ponto
            return parseFloat(str.replace(/[^0-9,-]/g, '').replace(',', '.'));
        }

        /** Formata o valor no input para R$ em tempo real */
        accountValueInput.addEventListener('input', function(e) {
            let value = e.target.value;
            // Remove tudo que n√£o for d√≠gito e v√≠rgula
            value = value.replace(/\D/g, ''); 
            
            if (value.length === 0) {
                e.target.value = '';
                return;
            }
            
            // Converte para float para formatar
            let floatValue = parseInt(value, 10) / 100;
            e.target.value = floatValue.toLocaleString('pt-BR', { 
                style: 'currency', 
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        });

        /** Adiciona feedback visual (pulso) ao selecionar o tipo */
        document.querySelectorAll('input[name="account-type"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const type = e.target.value;
                const pulseClass = type === 'entrada' ? 'pulse-green' : 'pulse-red';
                
                // Remove qualquer classe de pulso existente
                typeSelector.classList.remove('pulse-green', 'pulse-red');
                
                // For√ßa o reflow para reiniciar a anima√ß√£o
                void typeSelector.offsetWidth; 

                // Adiciona a nova classe de pulso
                typeSelector.classList.add(pulseClass);

                // Remove a classe ap√≥s a anima√ß√£o (para que possa pulsar novamente)
                setTimeout(() => {
                    typeSelector.classList.remove(pulseClass);
                }, 500); 
            });
        });

        // --- 3. TEMA CLARO/ESCURO ---

        function toggleTheme() {
            const isDarkMode = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            
            // Atualiza o √≠cone
            const icon = themeToggleBtn.querySelector('.material-icons');
            icon.textContent = isDarkMode ? 'light_mode' : 'dark_mode';
        }
        
        themeToggleBtn.addEventListener('click', toggleTheme);
        
        // Carrega o tema do localStorage
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggleBtn.querySelector('.material-icons').textContent = 'light_mode';
        }


        // --- 4. NAVEGA√á√ÉO ENTRE VISTAS ---

        function switchView(viewId) {
            viewDashboard.style.display = 'none';
            viewCategories.style.display = 'none';
            
            document.getElementById(viewId).style.display = 'block';
            
            // Destaca o bot√£o ativo (poderia ser melhorado com Tailwind)
            navDashboard.classList.remove('btn-success');
            navCategories.classList.remove('btn-success');
            document.getElementById(`nav-${viewId.replace('view-', '')}`).classList.add('btn-success');
        }

        navDashboard.addEventListener('click', () => switchView('view-dashboard'));
        navCategories.addEventListener('click', () => switchView('view-categories'));


        // --- 5. FUN√á√ïES DE AUTENTICA√á√ÉO ---

        function updateUI(user) {
            if (user) {
                currentUserId = user.uid;
                loginArea.style.display = 'none';
                dashboardArea.style.display = 'block';
                logoutBtn.style.display = 'block';
                authError.textContent = ''; 

                // Ajusta as cole√ß√µes com o ID do usu√°rio
                COLLECTION_ACCOUNTS = `artifacts/${appId}/users/${currentUserId}/contas`;
                COLLECTION_CATEGORIES = `artifacts/${appId}/users/${currentUserId}/categorias`;

                // Ativa os listeners de tempo real
                setupRealtimeListeners(); 
                switchView('view-dashboard'); // Inicia no Dashboard
            } else {
                if (accountsUnsubscribe) accountsUnsubscribe();
                if (categoriesUnsubscribe) categoriesUnsubscribe();
                
                currentUserId = null;
                loginArea.style.display = 'block';
                dashboardArea.style.display = 'none';
                logoutBtn.style.display = 'none';
            }
        }
        
        async function authenticateUser() {
            if (initialAuthToken) {
                try {
                    // Tenta autenticar com o token personalizado
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Erro ao autenticar com token:", error);
                    // Em caso de erro, tenta autentica√ß√£o an√¥nima
                    await signInAnonymously(auth);
                }
            } else {
                // Se n√£o houver token, autentica anonimamente
                await signInAnonymously(auth);
            }
        }
        authenticateUser(); // Tentativa de autentica√ß√£o inicial
        
        onAuthStateChanged(auth, updateUI);

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            authError.textContent = '';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast('Login realizado com sucesso!', 'success');
            } catch (error) {
                console.error("Erro ao logar:", error);
                authError.textContent = 'Erro de Login: E-mail ou senha inv√°lidos.';
                showToast('Falha no Login. Verifique as credenciais.', 'error');
            }
        });

        signupBtn.addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            authError.textContent = '';
            
            if (password.length < 6) {
                authError.textContent = 'A senha deve ter pelo menos 6 caracteres.';
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showToast('Conta criada com sucesso! Voc√™ est√° logado.', 'success');
            } catch (error) {
                console.error("Erro ao criar conta:", error);
                authError.textContent = `Erro ao criar conta: ${error.message}`;
                showToast(`Erro ao criar conta: ${error.message}`, 'error');
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            showToast('Sess√£o encerrada.', 'info');
        });

        // --- 6. LISTENERS DE TEMPO REAL (onSnapshot) ---

        function setupRealtimeListeners() {
            if (!currentUserId) return;

            // 6.A Listener de Categorias
            const categoriesQuery = query(collection(db, COLLECTION_CATEGORIES));
            if (categoriesUnsubscribe) categoriesUnsubscribe(); // Remove listener anterior
            categoriesUnsubscribe = onSnapshot(categoriesQuery, (snapshot) => {
                const categories = [];
                snapshot.forEach(doc => {
                    categories.push({ id: doc.id, ...doc.data() });
                });
                renderCategorySelect(categories);
                renderCategoryTable(categories);
            }, (error) => {
                console.error("Erro ao ouvir categorias:", error);
                showToast('Erro ao carregar categorias.', 'error');
            });


            // 6.B Listener de Contas (Lan√ßamentos)
            const accountsQuery = query(collection(db, COLLECTION_ACCOUNTS));
            if (accountsUnsubscribe) accountsUnsubscribe(); // Remove listener anterior
            accountsUnsubscribe = onSnapshot(accountsQuery, (snapshot) => {
                allAccountsData = [];
                snapshot.forEach(doc => {
                    allAccountsData.push({ id: doc.id, ...doc.data() });
                });

                // Atualiza todas as vis√µes que dependem dos lan√ßamentos
                fetchAndRenderDashboardSummary(allAccountsData);
                renderAccountsTable(allAccountsData);
                fetchAndRenderChartData(allAccountsData);
                
                // Renderiza os vencimentos para o filtro padr√£o (7 dias)
                renderUpcomingAccounts(7); 
            }, (error) => {
                console.error("Erro ao ouvir contas:", error);
                showToast('Erro ao carregar lan√ßamentos.', 'error');
            });
        }


        // --- 7. CATEGORIAS (CRUD) ---

        /** Renderiza as op√ß√µes de categorias no SELECT do formul√°rio de lan√ßamento */
        function renderCategorySelect(categories) {
            const selectCategory = document.getElementById('account-category');
            selectCategory.innerHTML = '<option value="">Selecione a Categoria</option>';
            
            if (categories.length === 0) {
                selectCategory.innerHTML = '<option value="" disabled>Nenhuma categoria. Crie uma.</option>';
                return;
            }
            
            categories.forEach((cat) => {
                const option = document.createElement('option');
                option.value = cat.nome;
                option.textContent = cat.nome;
                selectCategory.appendChild(option);
            });
        }

        /** Renderiza a tabela de categorias na vis√£o de gest√£o */
        function renderCategoryTable(categories) {
            categoriesTableBody.innerHTML = '';
            if (categories.length === 0) {
                categoriesTableBody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--color-text-light);">Nenhuma categoria cadastrada.</td></tr>';
                return;
            }

            categories.forEach(cat => {
                const row = categoriesTableBody.insertRow();
                row.innerHTML = `
                    <td>${cat.nome}</td>
                    <td>
                        <button class="btn-secondary" onclick="editCategory('${cat.id}', '${cat.nome}')">Editar</button>
                        <button class="btn-danger" onclick="deleteCategory('${cat.id}')">Excluir</button>
                    </td>
                `;
            });
        }
        
        /** Fun√ß√£o para iniciar a edi√ß√£o de categoria (global para onclick) */
        window.editCategory = (id, nome) => {
            document.getElementById('category-doc-id').value = id;
            document.getElementById('category-name').value = nome;
            document.getElementById('save-category-btn').textContent = 'Atualizar Categoria';
            document.getElementById('cancel-category-btn').style.display = 'inline-block';
        };

        /** Fun√ß√£o para cancelar a edi√ß√£o de categoria */
        document.getElementById('cancel-category-btn').addEventListener('click', () => {
            newCategoryForm.reset();
            document.getElementById('category-doc-id').value = '';
            document.getElementById('save-category-btn').textContent = 'Salvar Categoria';
            document.getElementById('cancel-category-btn').style.display = 'none';
        });

        /** Adicionar/Atualizar Categoria no Firestore */
        newCategoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) return showToast("Erro: Usu√°rio n√£o autenticado.", 'error');

            const id = document.getElementById('category-doc-id').value;
            const nome = document.getElementById('category-name').value;
            
            const categoryData = { nome, userId: currentUserId };

            try {
                if (id) {
                    // Edi√ß√£o
                    await updateDoc(doc(db, COLLECTION_CATEGORIES, id), categoryData);
                    showToast('Categoria atualizada com sucesso!', 'success');
                } else {
                    // Novo
                    await addDoc(collection(db, COLLECTION_CATEGORIES), { ...categoryData, createdAt: new Date().toISOString() });
                    showToast('Categoria salva com sucesso!', 'success');
                }
                newCategoryForm.reset();
                document.getElementById('category-doc-id').value = '';
                document.getElementById('save-category-btn').textContent = 'Salvar Categoria';
                document.getElementById('cancel-category-btn').style.display = 'none';
            } catch (e) {
                console.error("Erro ao salvar categoria: ", e);
                showToast('Erro ao salvar categoria. Verifique o console.', 'error');
            }
        });

        /** Fun√ß√£o para excluir categoria (global para onclick) */
        window.deleteCategory = async (id) => {
            if (!currentUserId) return showToast("Erro: Usu√°rio n√£o autenticado.", 'error');
            if (!confirm('Tem certeza que deseja excluir esta categoria?')) return; // Confirma√ß√£o simples

            try {
                await deleteDoc(doc(db, COLLECTION_CATEGORIES, id));
                showToast('Categoria exclu√≠da com sucesso!', 'info');
            } catch (e) {
                console.error("Erro ao excluir categoria: ", e);
                showToast('Erro ao excluir categoria.', 'error');
            }
        };


        // --- 8. LAN√áAMENTOS (CRUD) ---

        /** Adicionar/Atualizar Lan√ßamento no Firestore */
        newAccountForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) return showToast("Erro: Usu√°rio n√£o autenticado.", 'error');

            const docId = document.getElementById('account-doc-id').value;
            const valorFormatado = accountValueInput.value;

            const data = {
                nome: document.getElementById('account-name').value,
                categoria: document.getElementById('account-category').value,
                // Usar parseCurrency para garantir que o valor seja um n√∫mero
                valor: parseCurrency(valorFormatado), 
                vencimento: document.getElementById('account-due-date').value,
                tipo: document.querySelector('input[name="account-type"]:checked').value,
                // Mant√©m o status ao editar, ou define como "pendente" para novo
                status: docId ? allAccountsData.find(a => a.id === docId)?.status || "pendente" : "pendente", 
                repeticao: "nao", // Simplifica√ß√£o
            };

            try {
                if (docId) {
                    // Edi√ß√£o
                    await updateDoc(doc(db, COLLECTION_ACCOUNTS, docId), data);
                    showToast('Lan√ßamento atualizado com sucesso!', 'success');
                } else {
                    // Novo
                    await addDoc(collection(db, COLLECTION_ACCOUNTS), {
                        ...data,
                        userId: currentUserId, 
                        createdAt: new Date().toISOString() 
                    });
                    showToast('Lan√ßamento salvo com sucesso!', 'success');
                }
                
                // Resetar formul√°rio e modo de edi√ß√£o
                resetAccountForm();
            } catch (e) {
                console.error("Erro ao salvar lan√ßamento: ", e);
                showToast('Erro ao salvar lan√ßamento. Verifique o console.', 'error');
            }
        });

        function resetAccountForm() {
            newAccountForm.reset();
            document.getElementById('account-doc-id').value = '';
            document.getElementById('save-account-btn').textContent = 'Salvar Lan√ßamento';
            document.getElementById('cancel-edit-btn').style.display = 'none';
        }
        
        document.getElementById('cancel-edit-btn').addEventListener('click', resetAccountForm);

        /** Fun√ß√£o para iniciar a edi√ß√£o de um lan√ßamento (global para onclick) */
        window.editAccount = (id) => {
            const account = allAccountsData.find(a => a.id === id);
            if (!account) return showToast('Lan√ßamento n√£o encontrado.', 'error');
            
            document.getElementById('account-doc-id').value = account.id;
            document.getElementById('account-name').value = account.nome;
            document.getElementById('account-category').value = account.categoria;
            // Define o valor j√° formatado
            accountValueInput.value = formatCurrency(account.valor); 
            document.getElementById('account-due-date').value = account.vencimento;
            document.querySelector(`input[name="account-type"][value="${account.tipo}"]`).checked = true;

            // Altera o bot√£o para modo edi√ß√£o
            document.getElementById('save-account-btn').textContent = 'Atualizar Lan√ßamento';
            document.getElementById('cancel-edit-btn').style.display = 'inline-block';
            
            // Rola para o formul√°rio
            document.getElementById('new-account-form').scrollIntoView({ behavior: 'smooth' });
        };

        /** Fun√ß√£o para excluir um lan√ßamento (global para onclick) */
        window.deleteAccount = async (id) => {
            if (!currentUserId) return showToast("Erro: Usu√°rio n√£o autenticado.", 'error');
            if (!confirm('Tem certeza que deseja excluir este lan√ßamento?')) return; 

            try {
                await deleteDoc(doc(db, COLLECTION_ACCOUNTS, id));
                showToast('Lan√ßamento exclu√≠do com sucesso!', 'info');
            } catch (e) {
                console.error("Erro ao excluir lan√ßamento: ", e);
                showToast('Erro ao excluir lan√ßamento.', 'error');
            }
        };

        /** Fun√ß√£o para marcar um lan√ßamento como pago (global para onclick) */
        window.markAsPaid = async (id) => {
            if (!currentUserId) return showToast("Erro: Usu√°rio n√£o autenticado.", 'error');
            
            try {
                await updateDoc(doc(db, COLLECTION_ACCOUNTS, id), { status: 'pago' });
                showToast('Conta marcada como paga/recebida!', 'success');
            } catch (e) {
                console.error("Erro ao atualizar status: ", e);
                showToast('Erro ao marcar como pago/recebido.', 'error');
            }
        };

        // --- 9. DASHBOARD E GR√ÅFICOS ---

        /** Renderiza os cards de resumo (Saldo, Entradas, Sa√≠das) */
        function fetchAndRenderDashboardSummary(accounts) {
            const summaryCards = document.getElementById('summary-cards');
            let totalEntradas = 0;
            let totalSaidas = 0;
            let contasDoMes = 0;
            let saldoFinal = 0;

            // Apenas contas PAGAS e PENDENTES contribuem para o saldo
            accounts.forEach((data) => {
                contasDoMes++;
                if (data.status === 'pago' || data.status === 'pendente') {
                     if (data.tipo === 'entrada') {
                        totalEntradas += data.valor;
                    } else if (data.tipo === 'saida') {
                        totalSaidas += data.valor;
                    }
                }
            });

            saldoFinal = totalEntradas - totalSaidas;
            const saldoCor = saldoFinal >= 0 ? 'var(--color-success-green)' : 'var(--color-danger-red)';
            
            summaryCards.innerHTML = `
                <div class="card" style="border-left: 5px solid var(--color-primary-blue);">
                    <h3>Total de Lan√ßamentos</h3>
                    <p>Total: <strong>${contasDoMes}</strong></p>
                </div>
                <div class="card" style="border-left: 5px solid var(--color-success-green);">
                    <h3>Total de Entradas (Previsto)</h3>
                    <p><strong>${formatCurrency(totalEntradas)}</strong></p>
                </div>
                <div class="card" style="border-left: 5px solid var(--color-danger-red);">
                    <h3>Total de Sa√≠das (Previsto)</h3>
                    <p><strong>${formatCurrency(totalSaidas)}</strong></p>
                </div>
                <div class="card" style="background-color: ${saldoCor}; color: white;">
                    <h3>Saldo Atual (Previsto)</h3>
                    <p style="font-size: 1.5rem;"><strong>${formatCurrency(saldoFinal)}</strong></p>
                </div>
            `;
        }

        /** Prepara os dados e renderiza o gr√°fico de evolu√ß√£o mensal */
        function fetchAndRenderChartData(accounts) {
            // Agrupa por m√™s/ano e calcula o total
            const monthlyData = accounts.reduce((acc, account) => {
                const date = new Date(account.vencimento);
                const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!acc[monthYear]) {
                    acc[monthYear] = { entradas: 0, saidas: 0, saldo: 0 };
                }

                if (account.tipo === 'entrada') {
                    acc[monthYear].entradas += account.valor;
                } else if (account.tipo === 'saida') {
                    acc[monthYear].saidas += account.valor;
                }

                return acc;
            }, {});
            
            // Calcula o saldo cumulativo e formata os labels
            const sortedMonths = Object.keys(monthlyData).sort();
            let cumulativeBalance = 0;

            const labels = sortedMonths.map(my => {
                const [year, month] = my.split('-');
                return new Date(year, month - 1).toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
            });
            const entradasData = sortedMonths.map(my => monthlyData[my].entradas);
            const saidasData = sortedMonths.map(my => monthlyData[my].saidas);
            
            // Calcula o saldo de cada m√™s e o saldo cumulativo
            const saldoData = sortedMonths.map(my => {
                const { entradas, saidas } = monthlyData[my];
                cumulativeBalance += (entradas - saidas);
                return cumulativeBalance; // Gr√°fico de saldo cumulativo
            });

            renderChart(labels, entradasData, saidasData, saldoData);
        }

        /** Renderiza o gr√°fico Chart.js */
        function renderChart(labels, entradasData, saidasData, saldoData) {
            if (myChart) {
                myChart.destroy(); // Destr√≥i a inst√¢ncia anterior, se existir
            }
            
            const ctx = balanceChartCanvas.getContext('2d');
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Entradas',
                            data: entradasData,
                            backgroundColor: 'rgba(16, 185, 129, 0.5)',
                            borderColor: 'var(--color-success-green)',
                            tension: 0.3,
                            fill: false,
                        },
                        {
                            label: 'Sa√≠das',
                            data: saidasData,
                            backgroundColor: 'rgba(239, 68, 68, 0.5)',
                            borderColor: 'var(--color-danger-red)',
                            tension: 0.3,
                            fill: false,
                        },
                        {
                            label: 'Saldo Cumulativo',
                            data: saldoData,
                            backgroundColor: 'rgba(79, 70, 229, 0.8)',
                            borderColor: 'var(--color-primary-blue)',
                            tension: 0.3,
                            fill: true,
                            yAxisID: 'y1', // Opcional, se quisermos duas escalas
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Entradas / Sa√≠das (R$)'
                            }
                        },
                        // Se quiser uma escala separada para o Saldo
                        y1: {
                            position: 'right',
                            grid: {
                                drawOnChartArea: false, // S√≥ o eixo principal tem linhas de grade
                            },
                            title: {
                                display: false,
                                text: 'Saldo Cumulativo (R$)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- 10. VENCIMENTOS E FILTROS ---

        upcomingFilters.addEventListener('click', (e) => {
            const days = e.target.getAttribute('data-days');
            if (days) {
                // Remove destaque dos bot√µes
                upcomingFilters.querySelectorAll('button').forEach(btn => btn.classList.remove('btn-success'));
                // Adiciona destaque ao bot√£o clicado
                e.target.classList.add('btn-success');
                renderUpcomingAccounts(parseInt(days, 10));
            }
        });

        /** Renderiza a lista de contas com vencimento nos pr√≥ximos X dias */
        function renderUpcomingAccounts(days) {
            const today = new Date();
            const limitDate = new Date();
            limitDate.setDate(today.getDate() + days);

            const upcoming = allAccountsData.filter(account => {
                // Apenas contas pendentes e com vencimento futuro
                if (account.status !== 'pendente') return false; 
                
                const dueDate = new Date(account.vencimento + 'T00:00:00'); // Garante compara√ß√£o correta
                return dueDate >= today && dueDate <= limitDate;
            }).sort((a, b) => new Date(a.vencimento) - new Date(b.vencimento));

            upcomingAccountsList.innerHTML = '';

            if (upcoming.length === 0) {
                upcomingAccountsList.innerHTML = `<li style="color: var(--color-text-light);">Nenhum lan√ßamento pendente nos pr√≥ximos ${days} dias.</li>`;
                return;
            }

            upcoming.forEach(account => {
                const dueDate = new Date(account.vencimento + 'T00:00:00');
                const diffTime = Math.abs(dueDate - today);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                const li = document.createElement('li');
                li.className = 'upcoming-item';
                li.innerHTML = `
                    <div class="${account.tipo === 'entrada' ? 'tipo-entrada' : 'tipo-saida'}">
                        <strong>${account.nome}</strong> (${account.categoria})<br>
                        ${formatCurrency(account.valor)} - Vence em ${diffDays} dias (${account.vencimento.split('-').reverse().join('/')})
                    </div>
                    <button class="btn-success" onclick="markAsPaid('${account.id}')">Pagar</button>
                `;
                upcomingAccountsList.appendChild(li);
            });
        }
        
        // --- 11. LISTA DE TODAS AS CONTAS (Tabela) ---
        
        function renderAccountsTable(accounts) {
            accountsTableBody.innerHTML = '';

            if (accounts.length === 0) {
                accountsTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--color-text-light);">Nenhum lan√ßamento cadastrado.</td></tr>';
                return;
            }

            accounts.sort((a, b) => new Date(b.vencimento) - new Date(a.vencimento)); // Mais recente primeiro

            accounts.forEach(account => {
                const row = accountsTableBody.insertRow();
                row.innerHTML = `
                    <td>${account.nome}</td>
                    <td class="${account.tipo === 'entrada' ? 'tipo-entrada' : 'tipo-saida'}">${formatCurrency(account.valor)}</td>
                    <td class="${account.tipo === 'entrada' ? 'tipo-entrada' : 'tipo-saida'}">${account.tipo.toUpperCase()}</td>
                    <td class="status-${account.status}">${account.status.toUpperCase()}</td>
                    <td>${account.vencimento.split('-').reverse().join('/')}</td>
                    <td>
                        <button class="btn-secondary" onclick="editAccount('${account.id}')">Editar</button>
                        ${account.status === 'pendente' ? `<button class="btn-success" onclick="markAsPaid('${account.id}')">Pagar/Receber</button>` : ''}
                        <button class="btn-danger" onclick="deleteAccount('${account.id}')">Excluir</button>
                    </td>
                `;
            });
        }
    </script>
</body>
</html>
